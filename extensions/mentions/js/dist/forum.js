(()=>{var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{extend:()=>Kt,filterGroupMentions:()=>ne,filterPostMentions:()=>te,filterTagMentions:()=>se,filterUserMentions:()=>Vt,postFilterGroupMentions:()=>oe,postFilterPostMentions:()=>ee,postFilterTagMentions:()=>re,postFilterUserMentions:()=>Zt});var n={};t.r(n),t.d(n,{default:()=>W,insertMention:()=>G});var o={};t.r(o),t.d(o,{filterGroupMentions:()=>ne,filterPostMentions:()=>te,filterTagMentions:()=>se,filterUserMentions:()=>Vt,postFilterGroupMentions:()=>oe,postFilterPostMentions:()=>ee,postFilterTagMentions:()=>re,postFilterUserMentions:()=>Zt});const s=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/app"];var i=t.n(r);const a=flarum.core.compat["forum/components/NotificationGrid"];var c=t.n(a);const l=flarum.core.compat["common/utils/string"],u=flarum.core.compat["common/helpers/textContrastClass"];var d=t.n(u);const f=flarum.core.compat["forum/components/Post"];var p=t.n(f);const h=flarum.core.compat["forum/components/CommentPost"];var g=t.n(h);const b=flarum.core.compat["forum/components/PostPreview"];var y=t.n(b);const v=flarum.core.compat["common/components/LoadingIndicator"];var w=t.n(v);const x=flarum.core.compat["common/components/Link"];var M=t.n(x);const P=flarum.core.compat["common/helpers/punctuateSeries"];var C=t.n(P);const T=flarum.core.compat["common/helpers/username"];var A=t.n(T);const B=flarum.core.compat["common/helpers/icon"];var _=t.n(B);const N=flarum.core.compat["common/components/Button"];var S=t.n(N);const k=flarum.core.compat["common/components/Modal"];var F=t.n(k);const I=flarum.core.compat["common/states/PaginatedListState"];var L=t.n(I);class R extends(L()){constructor(t,e){void 0===e&&(e=1),t.page={...t.page||{},limit:10},super(t,e,10)}get type(){return"posts"}}class j extends(F()){oninit(t){super.oninit(t),this.state=new R({filter:{mentionedPost:this.attrs.post.id()},sort:"number"}),this.state.refresh()}className(){return"MentionedByModal"}title(){return i().translator.trans("flarum-mentions.forum.mentioned_by.title")}content(){return m("[",null,m("div",{className:"Modal-body"},this.state.isInitialLoading()?m(w(),null):m("[",null,m("ul",{className:"MentionedByModal-list Dropdown-menu Dropdown-menu--inline Post-mentionedBy-preview"},this.state.getPages().map((t=>t.items.map((t=>m("li",{"data-number":t.number()},m(y(),{post:t,onclick:()=>i().modal.close()}))))))))),this.state.hasNext()&&m("div",{className:"Modal-footer"},m("div",{className:"Form Form--centered"},m("div",{className:"Form-group"},m(S(),{className:"Button Button--block",onclick:()=>this.state.loadNext(),loading:this.state.isLoadingNext()},i().translator.trans("flarum-mentions.forum.mentioned_by.load_more_button"))))))}}const D=flarum.core.compat["forum/utils/DiscussionControls"];var U=t.n(D);const H=flarum.core.compat["forum/components/EditPostComposer"];var E=t.n(H);function G(t,e,n){return new Promise((o=>{const s=i().mentionFormats.mentionable("post").replacement(t)+" ";e.fields.content()||(e.body.attrs.originalContent=s);const r=e.editor.getSelectionRange()[0],a=e.fields.content().slice(0,r),c=0==a.length?0:3-a.match(/(\n{0,2})$/)[0].length;return e.editor.insertAtCursor(Array(c).join("\n")+(n?"> "+s+n.trim().replace(/\n/g,"\n> ")+"\n\n":s),!1),o(e)}))}function W(t,e){return i().composer.bodyMatches(E())&&i().composer.body.attrs.post.discussion()===t.discussion()?G(t,i().composer,e):U().replyAction.call(t.discussion()).then((n=>G(t,n,e)))}const O=flarum.core.compat["common/Fragment"];var q=t.n(O);class J extends(q()){constructor(t){super(),this.post=t}view(){return m("button",{className:"Button PostQuoteButton",onclick:()=>{W(this.post,this.content)}},_()("fas fa-quote-left",{className:"Button-icon"}),i().translator.trans("flarum-mentions.forum.post.quote_button"))}show(t,e){const n=this.$().show(),o=n.offsetParent().offset();n.css("left",t-o.left).css("top",e-o.top),this.hideHandler=this.hide.bind(this),$(document).on("mouseup",this.hideHandler)}showStart(t,e){const n=this.$();this.show(t,$(window).scrollTop()+e-n.outerHeight()-5)}showEnd(t,e){const n=this.$();this.show(t-n.outerWidth(),$(window).scrollTop()+e+5)}hide(){this.$().hide(),$(document).off("mouseup",this.hideHandler)}}function z(t){const e=window.getSelection();if(!e.isCollapsed){const n=e.getRangeAt(0),o=n.commonAncestorContainer;if(t[0]===o||$.contains(t[0],o)){const t=$("<div>").append(n.cloneContents());return t.find("img.emoji").replaceWith((function(){return this.alt})),t.find("img").replaceWith((function(){return"![](".concat(this.src,")")})),t.find("a").replaceWith((function(){return"[".concat(this.innerText,"](").concat(this.href,")")})),t.text()}}return""}const Q=flarum.core.compat["common/components/TextEditor"];var X=t.n(Q);const Y=flarum.core.compat["common/components/TextEditorButton"];var K=t.n(Y);const V=flarum.core.compat["common/utils/KeyboardNavigatable"];var Z=t.n(V);function tt(t){return tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tt(t)}function et(t,e,n){return(e=function(t){var e=function(t,e){if("object"!==tt(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e);if("object"!==tt(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"===tt(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class nt extends(q()){constructor(){super(...arguments),et(this,"items",[]),et(this,"active",!1),et(this,"index",0),et(this,"keyWasJustPressed",!1)}view(){return m("ul",{className:"Dropdown-menu MentionsDropdown"},this.items.map((t=>m("li",null,t))))}show(t,e){this.$().show().css({left:t+"px",top:e+"px"}),this.active=!0}hide(){this.$().hide(),this.active=!1}navigate(t){this.keyWasJustPressed=!0,this.setIndex(this.index+t,!0),clearTimeout(this.keyWasJustPressedTimeout),this.keyWasJustPressedTimeout=setTimeout((()=>this.keyWasJustPressed=!1),500)}complete(){this.$("li").eq(this.index).find("button").click()}setIndex(t,e){if(this.keyWasJustPressed&&!e)return;const n=this.$(),o=n.find("li");let s=t;s<0?s=o.length-1:s>=o.length&&(s=0),this.index=s;const r=o.removeClass("active").eq(s).addClass("active");if(e){const t=n.scrollTop(),e=n.offset().top,o=e+n.outerHeight(),s=r.offset().top,i=s+r.outerHeight();let a;s<e?a=t-e+s-parseInt(n.css("padding-top"),10):i>o&&(a=t-o+i+parseInt(n.css("padding-bottom"),10)),void 0!==a&&n.stop(!0).animate({scrollTop:a},100)}}}class ot{constructor(){et(this,"instances",void 0),et(this,"mentionables",void 0),et(this,"extendable",void 0)}makeMentionables(){var t;return null!=(t=this.instances)?t:this.instances=this.mentionables.map((t=>new t(this)))}getMentionable(t){var e;return null!=(e=this.makeMentionables().find((e=>e.type()===t)))?e:null}extend(t){if(!this.extendable)throw new Error("This mention format does not allow extending.");this.mentionables.push(t)}}const st=flarum.core.compat["common/helpers/avatar"];var rt=t.n(st);const it=flarum.core.compat["common/helpers/highlight"];var at=t.n(it);class ct{constructor(t){et(this,"format",void 0),this.format=t}}const mt=flarum.core.compat["common/utils/extractText"];var lt=t.n(mt);const ut=()=>lt()(i().translator.trans("core.lib.username.deleted_text"));function dt(t,e){return void 0===e&&(e=!0),t?((e?t.displayName():t.username())||ut()).replace(/"#[a-z]{0,3}[0-9]+/,"_"):ut().replace(/"#[a-z]{0,3}[0-9]+/,"_")}class ft extends ct{type(){return"user"}initialResults(){return Array.from(i().store.all("users"))}replacement(t){if(i().forum.attribute("allowUsernameMentionFormat")){const e=dt(t,!1);return this.format.format(e)}const e=dt(t);return this.format.format(e,"",t.id())}suggestion(t,e){const n=A()(t,(t=>at()(t,e)));return m("[",null,rt()(t),n)}matches(t,e){return!!e&&[t.username(),t.displayName()].some((t=>t.toLowerCase().substr(0,e.length)===e))}maxStoreMatchedResults(){return null}async search(t){return await i().store.find("users",{filter:{q:t},page:{limit:5}})}enabled(){return!0}}const pt=flarum.core.compat["forum/components/ReplyComposer"];var ht=t.n(pt);class gt extends ct{type(){return"post"}initialResults(){if(!i().composer.bodyMatches(ht())&&!i().composer.bodyMatches(E()))return[];const t=i().composer.body.attrs,e=t.post;return(e&&e.discussion()||t.discussion).posts().filter((t=>t&&"comment"===t.contentType()&&(!e||t.number()<e.number()))).sort(((t,e)=>e.createdAt().getTime()-t.createdAt().getTime()))}replacement(t){const e=dt(t.user());return this.format.format(e,"p",t.id())}suggestion(t,e){var n;const o=t.user()||null,s=A()(o,(t=>at()(t,e)));return m("[",null,rt()(o),s,[i().translator.trans("flarum-mentions.forum.composer.reply_to_post_text",{number:t.number()})," — ",(0,l.truncate)(null!=(n=t.contentPlain())?n:"",200)])}matches(t,e){const n=t.user(),o=i().mentionFormats.mentionable("user");return!e||n&&o.matches(n,e)}maxStoreMatchedResults(){return 5}search(t){return Promise.resolve([])}enabled(){return!0}}const bt=flarum.core.compat["common/models/Group"];var yt=t.n(bt);const vt=flarum.core.compat["common/components/Badge"];var wt=t.n(vt);class xt extends ct{type(){return"group"}initialResults(){return Array.from(i().store.all("groups").filter((t=>t.id()!==yt().GUEST_ID&&t.id()!==yt().MEMBER_ID)))}replacement(t){return this.format.format(t.namePlural(),"g",t.id())}suggestion(t,e){let n=t.namePlural();return e&&(n=at()(n,e)),m("[",null,m(wt(),{className:"Avatar Badge Badge--group--".concat(t.id()," Badge-icon"),color:t.color(),type:"group",icon:t.icon()}),m("span",{className:"username"},n))}matches(t,e){return!!e&&[t.namePlural().toLowerCase(),t.nameSingular().toLowerCase()].some((t=>t.toLowerCase().substr(0,e.length)===e))}maxStoreMatchedResults(){return null}search(t){return Promise.resolve([])}enabled(){var t,e,n;return null!=(t=null==(e=i().session)||null==(n=e.user)?void 0:n.canMentionGroups())&&t}}class Mt extends ot{constructor(){super(...arguments),et(this,"mentionables",[ft,gt,xt]),et(this,"extendable",!0)}trigger(){return"@"}queryFromTyped(t){const e=t.match(/^["“]?((?:(?!"#).)+)$/);return e?e[1]:null}format(t,e,n){return void 0===e&&(e=""),void 0===n&&(n=null),{simple:"@".concat(t),safe:'@"'.concat(t,'"#').concat(e).concat(n)}[n?"safe":"simple"]}}class Pt extends ct{type(){return"tag"}initialResults(){return Array.from(i().store.all("tags"))}replacement(t){return this.format.format(t.slug())}matches(t,e){return!!e&&[t.name().toLowerCase()].some((t=>t.toLowerCase().substr(0,e.length)===e))}maxStoreMatchedResults(){return null}async search(t){return await i().store.find("tags",{filter:{q:t},page:{limit:5}})}suggestion(t,e){let n=t.name();return e&&(n=at()(n,e)),m("[",null,m(wt(),{className:"Avatar",icon:t.icon(),color:t.color(),type:"tag"}),m("span",{className:"username"},n))}enabled(){return"flarum-tags"in flarum.extensions}}class Ct extends ot{constructor(){super(...arguments),et(this,"mentionables",[Pt]),et(this,"extendable",!1)}trigger(){return"#"}queryFromTyped(t){const e=t.match(/^[-_\p{L}\p{N}\p{M}]+$/giu);return e?e[0]:null}format(t){return"#".concat(t)}}class Tt{constructor(){et(this,"formats",[new Mt,new Ct])}get(t){var e;return null!=(e=this.formats.find((e=>e.trigger()===t)))?e:null}mentionable(t){for(const e of this.formats){const n=e.getMentionable(t);if(n)return n}return null}extend(t){this.formats.push(new t)}}const At=flarum.core.compat["common/Component"];var $t=t.n(At);const Bt=flarum.core.compat["common/utils/classList"];var _t=t.n(Bt);class Nt extends($t()){view(t){const{mentionable:e,...n}=this.attrs,o=_t()("MentionsDropdownItem","PostPreview","MentionsDropdown-".concat(e.type()));return m("button",Object.assign({className:o},n),m("span",{className:"PostPreview-content"},t.children))}}const St=flarum.core.compat["common/utils/throttleDebounce"];class kt{constructor(t){et(this,"mentionables",void 0),et(this,"results",{}),et(this,"typed",null),et(this,"searched",[]),et(this,"dropdownItemAttrs",{}),et(this,"search",(0,St.throttle)(250,(async()=>{if(!this.typed||this.typed.length<=1)return;const t=this.typed.toLowerCase();if(!this.searched.includes(t)){for(const e of this.mentionables)for(const n of await e.search(t))this.results[e.type()].has(n.id())||this.results[e.type()].set(n.id(),n);return this.searched.push(t),Promise.resolve()}}))),this.dropdownItemAttrs=t}init(t){this.typed=null,this.mentionables=t;for(const t of this.mentionables)this.results[t.type()]=new Map(t.initialResults().map((t=>[t.id(),t])))}matches(t,e){var n;return t.matches(e,(null==(n=this.typed)?void 0:n.toLowerCase())||"")}makeSuggestion(t,e){const n=t.suggestion(e,this.typed),o=t.replacement(e),{onclick:s,...r}=this.dropdownItemAttrs;return m(Nt,Object.assign({mentionable:t,onclick:()=>s(o)},r),n)}buildSuggestions(){const t=[];for(const e of this.mentionables){if(!e.enabled())continue;let n=Array.from(this.results[e.type()].values()).filter((t=>this.matches(e,t)));const o=e.maxStoreMatchedResults();o&&(n=n.splice(0,o));for(const o of n){const n=this.makeSuggestion(e,o);t.push(n)}}return t}}const Ft=flarum.core.compat["forum/components/Notification"];var It=t.n(Ft);class Lt extends(It()){icon(){return"fas fa-reply"}href(){const t=this.attrs.notification,e=t.subject(),n=t.content();return i().route.discussion(e.discussion(),n&&n.replyNumber)}content(){const t=this.attrs.notification.fromUser();return i().translator.trans("flarum-mentions.forum.notifications.post_mentioned_text",{user:t,count:1})}excerpt(){return(0,l.truncate)(this.attrs.notification.subject().contentPlain()||"",200)}}class Rt extends(It()){icon(){return"fas fa-at"}href(){const t=this.attrs.notification.subject();return i().route.discussion(t.discussion(),t.number())}content(){const t=this.attrs.notification.fromUser();return i().translator.trans("flarum-mentions.forum.notifications.user_mentioned_text",{user:t})}excerpt(){return(0,l.truncate)(this.attrs.notification.subject().contentPlain(),200)}}class jt extends(It()){icon(){return"fas fa-at"}href(){const t=this.attrs.notification.subject();return i().route.discussion(t.discussion(),t.number())}content(){const t=this.attrs.notification.fromUser();return i().translator.trans("flarum-mentions.forum.notifications.group_mentioned_text",{user:t})}excerpt(){return(0,l.truncate)(this.attrs.notification.subject().contentPlain(),200)}}const Dt=flarum.core.compat["forum/components/UserPage"];var Ut=t.n(Dt);const Ht=flarum.core.compat["common/components/LinkButton"];var Et=t.n(Ht);const Gt=flarum.core.compat["common/models/User"];var Wt=t.n(Gt);flarum.core.compat["common/Model"];const Ot=flarum.core.compat["common/extenders"];var qt=t.n(Ot);const Jt=flarum.core.compat["common/models/Post"];var zt=t.n(Jt);const Qt=flarum.core.compat["forum/components/PostsUserPage"];var Xt=t.n(Qt);class Yt extends(Xt()){loadResults(t){return i().store.find("posts",{filter:{type:"comment",mentioned:this.user.id()},page:{offset:t,limit:this.loadLimit},sort:"-createdAt"})}}const Kt=[(new(qt().Routes)).add("user.mentions","/u/:username/mentions",Yt),new(qt().Model)(zt()).hasMany("mentionedBy").attribute("mentionedByCount"),new(qt().Model)(Wt()).attribute("canMentionGroups")];function Vt(t){let e;if(i().forum.attribute("allowUsernameMentionFormat")&&t.hasAttribute("username")?e=i().store.getBy("users","username",t.getAttribute("username")):t.hasAttribute("id")&&(e=i().store.getById("users",t.getAttribute("id"))),e)return t.setAttribute("id",e.id()),t.setAttribute("slug",e.slug()),t.setAttribute("displayname",lt()(A()(e))),!0;t.invalidate()}function Zt(t){t.setAttribute("deleted",!1)}function te(t){const e=i().store.getById("posts",t.getAttribute("id"));if(e)return t.setAttribute("discussionid",e.discussion().id()),t.setAttribute("number",e.number()),t.setAttribute("displayname",lt()(A()(e.user()))),!0}function ee(t){t.setAttribute("deleted",!1)}function ne(t){var e,n;if(null!=(e=i().session)&&null!=(n=e.user)&&n.canMentionGroups()){const e=i().store.getById("groups",t.getAttribute("id"));if(e)return t.setAttribute("groupname",lt()(e.namePlural())),!0}t.invalidate()}function oe(t){var e,n;if(null!=(e=i().session)&&null!=(n=e.user)&&n.canMentionGroups()){const e=i().store.getById("groups",t.getAttribute("id"));t.setAttribute("color",e.color()),t.setAttribute("icon",e.icon()),t.setAttribute("deleted",!1)}}function se(t){if("flarum-tags"in flarum.extensions){const e=i().store.getBy("tags","slug",t.getAttribute("slug"));if(e)return t.setAttribute("id",e.id()),t.setAttribute("tagname",e.name()),!0}t.invalidate()}function re(t){if("flarum-tags"in flarum.extensions){const e=i().store.getBy("tags","slug",t.getAttribute("slug"));t.setAttribute("icon",e.icon()),t.setAttribute("color",e.color()),t.setAttribute("deleted",!1)}}const ie={"mentions/components/MentionsUserPage":Yt,"mentions/components/PostMentionedNotification":Lt,"mentions/components/UserMentionedNotification":Rt,"mentions/components/GroupMentionedNotification":jt,"mentions/fragments/AutocompleteDropdown":nt,"mentions/fragments/PostQuoteButton":J,"mentions/utils/getCleanDisplayName":dt,"mentions/utils/getMentionText":function(t,e,n){if(void 0!==t&&void 0===e)return i().mentionables.get("user").replacement(t);if(void 0!==t&&void 0!==e)return i().mentionables.get("post").replacement(i().store.getById("posts",e));if(void 0!==n)return i().mentionables.get("group").replacement(n);throw"No parameters were passed"},"mentions/utils/reply":n,"mentions/utils/selectedText":z,"mentions/utils/textFormatter":o,"mentions/mentionables/MentionableModel":ct,"mentions/mentionables/formats/MentionFormat":ot,"mentions/extenders/Mentionables":class{constructor(){et(this,"formats",[]),et(this,"mentionables",{})}format(t){return this.formats.push(t),this}mentionable(t,e){return this.mentionables[t]||(this.mentionables[t]=[]),this.mentionables[t].push(e),this}extend(t){for(const e of this.formats)t.mentionFormats.extend(e);for(const e in this.mentionables){const n=t.mentionFormats.get(e);if(n)for(const t of this.mentionables[e])n.extend(t)}}}},ae=flarum.core;i().initializers.add("flarum-mentions",(function(){!function(){function t(){const t=this.attrs.post.contentHtml();if(t===this.oldPostContentHtml||this.isEditing())return;this.oldPostContentHtml=t;const e=this.attrs.post,n=this.$();this.$().on("click",".UserMention:not(.UserMention--deleted), .PostMention:not(.PostMention--deleted), .TagMention:not(.TagMention--deleted)",(function(t){m.route.set(this.getAttribute("href")),t.preventDefault()})),this.$(".PostMention:not(.PostMention--deleted)").each((function(){const t=$(this),o=t.data("id");let s;const r=$('<ul class="Dropdown-menu PostMention-preview fade"/>');n.append(r);const i=()=>$('.PostStream-item[data-id="'.concat(o,'"]')),a=()=>{const s=i();let a=!1;if(s.length){const t=s.offset().top,e=window.pageYOffset;t>e&&t+s.height()<e+$(window).height()&&(s.addClass("pulsate"),a=!0)}if(!a){const s=()=>{const e=r.outerHeight(!0);let o=0;t.offset().top-e<$(window).scrollTop()+$("#header").outerHeight()?o+=t.outerHeight(!0):o-=e,r.show().css("top",t.offset().top-n.offset().top+o).css("left",t.offsetParent().offset().left-n.offset().left).css("max-width",t.offsetParent().width())},i=t=>{const n=t.discussion();m.render(r[0],[n!==e.discussion()&&m("li",null,m("span",{className:"PostMention-preview-discussion"},n.title())),m("li",null,m(y(),{post:t}))]),s()},a=app.store.getById("posts",o);a&&a.discussion()?i(a):(m.render(r[0],m(w(),null)),app.store.find("posts",o).then(i),s()),setTimeout((()=>r.off("transitionend").addClass("in")))}},c=()=>{i().removeClass("pulsate"),r.hasClass("in")&&r.removeClass("in").one("transitionend",(()=>r.hide()))};t.on("touchend",(t=>{t.cancelable&&t.preventDefault()})),t.add(r).hover((()=>{clearTimeout(s),s=setTimeout(a,250)}),(()=>{clearTimeout(s),i().removeClass("pulsate"),s=setTimeout(c,250)})).on("touchend",(t=>{a(),t.stopPropagation()})),$(document).on("touchend",c)}))}(0,s.extend)(g().prototype,"oncreate",t),(0,s.extend)(g().prototype,"onupdate",t)}(),function(){function t(){this.$(".Post-mentionedBy-preview").removeClass("in").one("transitionend",(function(){$(this).hide()}))}(0,s.extend)(g().prototype,"oncreate",(function(){let e;const n=this.attrs.post,o=n.mentionedBy();if(o&&o.length){const s=$('<ul class="Dropdown-menu Post-mentionedBy-preview fade"/>');this.$().append(s);const r=this.$(),a=this.$(".Post-mentionedBy"),c=()=>{!s.hasClass("in")&&s.is(":visible")||(m.render(s[0],m("[",null,o.map((e=>m("li",{"data-number":e.number()},m(y(),{post:e,onclick:t.bind(this)})))),o.length<n.mentionedByCount()&&m("li",{className:"Post-mentionedBy-preview-more"},m(S(),{className:"PostPreview Button",onclick:()=>{t.call(this),i().modal.show(j,{post:n})}},m("span",{className:"PostPreview-content"},m("span",{className:"PostPreview-badge Avatar"},_()("fas fa-reply-all")),m("span",null,i().translator.trans("flarum-mentions.forum.post.mentioned_by_more_text",{count:n.mentionedByCount()-o.length}))))))),s.show().css("top",a.offset().top-r.offset().top+a.outerHeight(!0)).css("left",a.offsetParent().offset().left-r.offset().left).css("max-width",r.width()),setTimeout((()=>s.off("transitionend").addClass("in"))))};a.add(s).hover((()=>{clearTimeout(e),e=setTimeout(c,250)}),(()=>{clearTimeout(e),e=setTimeout(t,250)})),this.$().find(".Post-mentionedBy-summary a").hover((function(){s.find('[data-number="'+$(this).data("number")+'"]').addClass("active")}),(function(){s.find("[data-number]").removeClass("active")}))}})),(0,s.extend)(g().prototype,"footerItems",(function(e){const n=this.attrs.post.mentionedBy();if(n&&n.length){const o=[],s=n.sort((t=>t.user()===i().session.user?-1:0)).filter((t=>{const e=t.user();if(-1===o.indexOf(e))return o.push(e),!0})),r=4,a=s.length>r,c=s.slice(0,a?r-1:r).map((e=>{const n=e.user();return m(M(),{href:i().route.post(e),onclick:t.bind(this),"data-number":e.number()},i().session.user===n?i().translator.trans("flarum-mentions.forum.post.you_text"):A()(n))}));if(a){const t=s.length-c.length;c.push(i().translator.trans("flarum-mentions.forum.post.others_text",{count:t}))}e.add("replies",m("div",{className:"Post-mentionedBy"},m("span",{className:"Post-mentionedBy-summary"},_()("fas fa-reply"),i().translator.trans("flarum-mentions.forum.post.mentioned_by".concat(s[0].user()===i().session.user?"_self":"","_text"),{count:c.length,users:C()(c)}))))}}))}(),(0,s.extend)(g().prototype,"actionItems",(function(t){const e=this.attrs.post;e.isHidden()||i().session.user&&!e.discussion().canReply()||t.add("reply",m(S(),{className:"Button Button--link",onclick:()=>W(e)},i().translator.trans("flarum-mentions.forum.post.reply_link")))})),(0,s.extend)(g().prototype,"oncreate",(function(){const t=this.attrs.post;if(t.isHidden()||i().session.user&&!t.discussion().canReply())return;const e=this.$(".Post-body"),n=$('<div class="Post-quoteButtonContainer"></div>'),o=new J(t),s=function(t){setTimeout((()=>{const s=z(e);if(s){o.content=s,m.render(n[0],o.render());const e=window.getSelection().getRangeAt(0).getClientRects(),r=e[0];if(t.clientY<r.bottom&&t.clientX-r.right<r.left-t.clientX)o.showStart(r.left,r.top);else{const t=e[e.length-1];o.showEnd(t.right,t.bottom)}}}),1)};this.$().after(n).on("mouseup",s),"ontouchstart"in window&&document.addEventListener("selectionchange",s,!1)})),function(){i().mentionFormats=new Tt;const t=$('<div class="ComposerBody-mentionsDropdownContainer"></div>'),e=new nt;(0,s.extend)(X().prototype,"oncreate",(function(){const n=this.$(".TextEditor-editor").wrap('<div class="ComposerBody-mentionsWrapper"></div>');this.navigator=new(Z()),this.navigator.when((()=>e.active)).onUp((()=>e.navigate(-1))).onDown((()=>e.navigate(1))).onSelect(e.complete.bind(e)).onCancel(e.hide.bind(e)).bindTo(n),n.after(t)})),(0,s.extend)(X().prototype,"buildEditorParams",(function(n){let o,s,r,a=new kt({onmouseenter:function(){e.setIndex($(this).parent().index())},onclick:t=>{this.attrs.composer.editor.replaceBeforeCursor(s-1,t+" "),e.hide()}});n.inputListeners.push((()=>{const n=this.attrs.composer.editor.getSelectionRange(),c=n[0];if(n[1]-c>0)return;const l=this.attrs.composer.editor.getLastNChars(30);s=0;let u=null;for(let t=l.length-1;t>=0;t--){const e=l.substr(t,1);if(u=i().mentionFormats.get(e),u&&(0===t||/\s/.test(l.substr(t-1,1)))){o=t+1,s=c-l.length+t+1,a.init(u.makeMentionables());break}}if(e.hide(),e.active=!1,s){var d;const n=l.substring(o).toLowerCase();if(r=u.queryFromTyped(n),!r)return;a.typed=r;const i=()=>{const n=a.buildSuggestions();if(n.length){e.items=n,m.render(t[0],e.render()),e.show();const o=this.attrs.composer.editor.getCaretCoordinates(s),r=e.$().outerWidth(),i=e.$().outerHeight(),a=e.$().offsetParent();let c=o.left,l=o.top+15;l+i>a.height()&&(l=o.top-i-15),c+r>a.width()&&(c=a.width()-r),l=Math.max(-(a.offset().top-$(document).scrollTop()),l),c=Math.max(-a.offset().left,c),e.show(c,l)}else e.active=!1,e.hide()};e.active=!0,i(),e.setIndex(0),e.$().scrollTop(0),null==(d=a.search())||d.then(i)}}))})),(0,s.extend)(X().prototype,"toolbarItems",(function(t){t.add("mention",m(K(),{onclick:()=>this.attrs.composer.editor.insertAtCursor(" @"),icon:"fas fa-at"},i().translator.trans("flarum-mentions.forum.composer.mention_tooltip")))}))}(),i().notificationComponents.postMentioned=Lt,i().notificationComponents.userMentioned=Rt,i().notificationComponents.groupMentioned=jt,(0,s.extend)(c().prototype,"notificationTypes",(function(t){t.add("postMentioned",{name:"postMentioned",icon:"fas fa-reply",label:i().translator.trans("flarum-mentions.forum.settings.notify_post_mentioned_label")}),t.add("userMentioned",{name:"userMentioned",icon:"fas fa-at",label:i().translator.trans("flarum-mentions.forum.settings.notify_user_mentioned_label")}),t.add("groupMentioned",{name:"groupMentioned",icon:"fas fa-at",label:i().translator.trans("flarum-mentions.forum.settings.notify_group_mentioned_label")})})),(0,s.extend)(Ut().prototype,"navItems",(function(t){const e=this.user;t.add("mentions",m(Et(),{href:i().route("user.mentions",{username:e.slug()}),name:"mentions",icon:"fas fa-at"},i().translator.trans("flarum-mentions.forum.user.mentions_link")),80)})),l.getPlainContent.removeSelectors.push("a.PostMention"),(0,s.extend)(p().prototype,"oncreate",(function(){this.$(".GroupMention--colored, .TagMention--colored").each((function(){this.classList.add(d()(getComputedStyle(this).getPropertyValue("--color")))}))}))})),Object.assign(ae.compat,ie)})(),module.exports=e})();
//# sourceMappingURL=forum.js.map