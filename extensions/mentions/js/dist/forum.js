(()=>{var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{extend:()=>Wt,filterGroupMentions:()=>Qt,filterPostMentions:()=>Jt,filterTagMentions:()=>Yt,filterUserMentions:()=>qt,postFilterGroupMentions:()=>Xt,postFilterPostMentions:()=>zt,postFilterTagMentions:()=>Kt,postFilterUserMentions:()=>Ot});const n=flarum.reg.get("core","common/extend"),o=flarum.reg.get("core","forum/app");var s=t.n(o);const r=flarum.reg.get("core","common/utils/string"),i=flarum.reg.get("core","common/helpers/textContrastClass");var a=t.n(i);const u=flarum.reg.get("core","forum/components/Post");var l=t.n(u);const c=flarum.reg.get("core","forum/components/CommentPost");var d=t.n(c);const f=flarum.reg.get("core","forum/components/PostPreview");var p=t.n(f);const h=flarum.reg.get("core","common/components/LoadingIndicator");var g=t.n(h);const b=flarum.reg.get("core","common/components/Link");var y=t.n(b);const v=flarum.reg.get("core","common/helpers/punctuateSeries");var w=t.n(v);const M=flarum.reg.get("core","common/helpers/username");var x=t.n(M);const P=flarum.reg.get("core","common/components/Icon");var C=t.n(P);const T=flarum.reg.get("core","common/components/Button");var A=t.n(T);const B=flarum.reg.get("core","common/components/Modal");var _=t.n(B);const N=flarum.reg.get("core","common/states/PaginatedListState");var S=t.n(N);class k extends(S()){constructor(t,e){void 0===e&&(e=1),t.page={...t.page||{},limit:10},super(t,e,10)}get type(){return"posts"}}flarum.reg.add("flarum-mentions","forum/state/MentionedByModalState",k);const F=flarum.reg.get("core","common/components/Form");var I=t.n(F);class L extends(_()){oninit(t){super.oninit(t),this.state=new k({filter:{mentionedPost:this.attrs.post.id()},sort:"number"}),this.state.refresh()}className(){return"MentionedByModal"}title(){return s().translator.trans("flarum-mentions.forum.mentioned_by.title")}content(){return m("[",null,m("div",{className:"Modal-body"},this.state.isInitialLoading()?m(g(),null):m("[",null,m("ul",{className:"MentionedByModal-list Dropdown-menu Dropdown-menu--inline Post-mentionedBy-preview"},this.state.getPages().map((t=>t.items.map((t=>m("li",{"data-number":t.number()},m(p(),{post:t,onclick:()=>s().modal.close()}))))))))),this.state.hasNext()&&m("div",{className:"Modal-footer"},m(I(),{className:"Form--centered"},m("div",{className:"Form-group"},m(A(),{className:"Button Button--block",onclick:()=>this.state.loadNext(),loading:this.state.isLoadingNext()},s().translator.trans("flarum-mentions.forum.mentioned_by.load_more_button"))))))}}flarum.reg.add("flarum-mentions","forum/components/MentionedByModal",L);const R=flarum.reg.get("core","forum/utils/DiscussionControls");var D=t.n(R);function U(t,e,n){return new Promise((o=>{const r=s().mentionFormats.mentionable("post").replacement(t)+" ";e.fields.content()||(e.body.attrs.originalContent=r);const i=e.editor.getSelectionRange()[0],a=e.fields.content().slice(0,i),m=0==a.length?0:3-a.match(/(\n{0,2})$/)[0].length;return e.editor.insertAtCursor(Array(m).join("\n")+(n?"> "+r+n.trim().replace(/\n/g,"\n> ")+"\n\n":r),!1),o(e)}))}function j(t,e){const n=flarum.reg.checkModule("core","forum/components/EditPostComposer");return n&&s().composer.bodyMatches(n)&&s().composer.body.attrs.post.discussion()===t.discussion()?U(t,s().composer,e):D().replyAction.call(t.discussion()).then((n=>U(t,n,e)))}flarum.reg.add("flarum-mentions","forum/utils/reply",j);const E=flarum.reg.get("core","common/Fragment");var H=t.n(E);class G extends(H()){constructor(t){super(),this.post=t}view(){return m("button",{className:"Button PostQuoteButton",onclick:()=>{j(this.post,this.content)}},m(C(),{name:"fas fa-quote-left",className:"Button-icon"}),s().translator.trans("flarum-mentions.forum.post.quote_button"))}show(t,e){const n=this.$().show(),o=n.offsetParent().offset();n.css("left",t-o.left).css("top",e-o.top),this.hideHandler=this.hide.bind(this),$(document).on("mouseup",this.hideHandler)}showStart(t,e){const n=this.$();this.show(t,$(window).scrollTop()+e-n.outerHeight()-5)}showEnd(t,e){const n=this.$();this.show(t-n.outerWidth(),$(window).scrollTop()+e+5)}hide(){this.$().hide(),$(document).off("mouseup",this.hideHandler)}}function W(t){const e=window.getSelection();if(!e.isCollapsed){const n=e.getRangeAt(0),o=n.commonAncestorContainer;if(t[0]===o||$.contains(t[0],o)){const t=$("<div>").append(n.cloneContents());return t.find("img.emoji").replaceWith((function(){return this.alt})),t.find("img").replaceWith((function(){return"![](".concat(this.src,")")})),t.find("a").replaceWith((function(){return"[".concat(this.innerText,"](").concat(this.href,")")})),t.text()}}return""}flarum.reg.add("flarum-mentions","forum/fragments/PostQuoteButton",G),flarum.reg.add("flarum-mentions","forum/utils/selectedText",W);const q=flarum.reg.get("core","common/components/TextEditorButton");var O=t.n(q);const J=flarum.reg.get("core","common/utils/KeyboardNavigatable");var z=t.n(J);function Q(t){return Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Q(t)}function X(t,e,n){return(e=function(t){var e=function(t,e){if("object"!==Q(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e);if("object"!==Q(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"===Q(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class Y extends(H()){constructor(){super(...arguments),X(this,"items",[]),X(this,"active",!1),X(this,"index",0),X(this,"keyWasJustPressed",!1)}view(){return m("ul",{className:"Dropdown-menu MentionsDropdown"},this.items.map((t=>m("li",null,t))))}show(t,e){this.$().show().css({left:t+"px",top:e+"px"}),this.active=!0}hide(){this.$().hide(),this.active=!1}navigate(t){this.keyWasJustPressed=!0,this.setIndex(this.index+t,!0),clearTimeout(this.keyWasJustPressedTimeout),this.keyWasJustPressedTimeout=setTimeout((()=>this.keyWasJustPressed=!1),500)}complete(){this.$("li").eq(this.index).find("button").click()}setIndex(t,e){if(this.keyWasJustPressed&&!e)return;const n=this.$(),o=n.find("li");let s=t;s<0?s=o.length-1:s>=o.length&&(s=0),this.index=s;const r=o.removeClass("active").eq(s).addClass("active");if(e){const t=n.scrollTop(),e=n.offset().top,o=e+n.outerHeight(),s=r.offset().top,i=s+r.outerHeight();let a;s<e?a=t-e+s-parseInt(n.css("padding-top"),10):i>o&&(a=t-o+i+parseInt(n.css("padding-bottom"),10)),void 0!==a&&n.stop(!0).animate({scrollTop:a},100)}}}flarum.reg.add("flarum-mentions","forum/fragments/AutocompleteDropdown",Y);const K=flarum.reg.get("core","common/Component");var V=t.n(K);const Z=flarum.reg.get("core","common/utils/classList");var tt=t.n(Z);class et extends(V()){view(t){const{mentionable:e,...n}=this.attrs,o=tt()("MentionsDropdownItem","PostPreview","MentionsDropdown-".concat(e.type()));return m("button",Object.assign({className:o},n),m("span",{className:"PostPreview-content"},t.children))}}flarum.reg.add("flarum-mentions","forum/components/MentionsDropdownItem",et);const nt=flarum.reg.get("core","common/utils/throttleDebounce");class ot{constructor(t){X(this,"mentionables",void 0),X(this,"results",{}),X(this,"typed",null),X(this,"searched",[]),X(this,"dropdownItemAttrs",{}),X(this,"search",(0,nt.throttle)(250,(async()=>{if(!this.typed||this.typed.length<=1)return;const t=this.typed.toLowerCase();if(!this.searched.includes(t)){for(const e of this.mentionables)for(const n of await e.search(t))this.results[e.type()].has(n.id())||this.results[e.type()].set(n.id(),n);return this.searched.push(t),Promise.resolve()}}))),this.dropdownItemAttrs=t}init(t){this.typed=null,this.mentionables=t;for(const t of this.mentionables)this.results[t.type()]=new Map(t.initialResults().map((t=>[t.id(),t])))}matches(t,e){var n;return t.matches(e,(null==(n=this.typed)?void 0:n.toLowerCase())||"")}makeSuggestion(t,e){const n=t.suggestion(e,this.typed),o=t.replacement(e),{onclick:s,...r}=this.dropdownItemAttrs;return m(et,Object.assign({mentionable:t,onclick:()=>s(o)},r),n)}buildSuggestions(){const t=[];for(const e of this.mentionables){if(!e.enabled())continue;let n=Array.from(this.results[e.type()].values()).filter((t=>this.matches(e,t)));const o=e.maxStoreMatchedResults();o&&(n=n.splice(0,o));for(const o of n){const n=this.makeSuggestion(e,o);t.push(n)}}return t}}flarum.reg.add("flarum-mentions","forum/mentionables/MentionableModels",ot);const st=flarum.reg.get("core","forum/components/Notification");var rt=t.n(st);class it extends(rt()){icon(){return"fas fa-reply"}href(){const t=this.attrs.notification,e=t.subject(),n=t.content();return s().route.discussion(e.discussion(),n&&n.replyNumber)}content(){const t=this.attrs.notification.fromUser();return s().translator.trans("flarum-mentions.forum.notifications.post_mentioned_text",{user:t,count:1})}excerpt(){return(0,r.truncate)(this.attrs.notification.subject().contentPlain()||"",200)}}flarum.reg.add("flarum-mentions","forum/components/PostMentionedNotification",it);class at extends(rt()){icon(){return"fas fa-at"}href(){const t=this.attrs.notification.subject();return s().route.discussion(t.discussion(),t.number())}content(){const t=this.attrs.notification.fromUser();return s().translator.trans("flarum-mentions.forum.notifications.user_mentioned_text",{user:t})}excerpt(){return(0,r.truncate)(this.attrs.notification.subject().contentPlain(),200)}}flarum.reg.add("flarum-mentions","forum/components/UserMentionedNotification",at);class mt extends(rt()){icon(){return"fas fa-at"}href(){const t=this.attrs.notification.subject();return s().route.discussion(t.discussion(),t.number())}content(){const t=this.attrs.notification.fromUser();return s().translator.trans("flarum-mentions.forum.notifications.group_mentioned_text",{user:t})}excerpt(){return(0,r.truncate)(this.attrs.notification.subject().contentPlain(),200)}}flarum.reg.add("flarum-mentions","forum/components/GroupMentionedNotification",mt);class ut{constructor(){X(this,"instances",void 0),X(this,"mentionables",void 0),X(this,"extendable",void 0)}makeMentionables(){var t;return null!=(t=this.instances)?t:this.instances=this.mentionables.map((t=>new t(this)))}getMentionable(t){var e;return null!=(e=this.makeMentionables().find((e=>e.type()===t)))?e:null}extend(t){if(!this.extendable)throw new Error("This mention format does not allow extending.");this.mentionables.push(t)}}flarum.reg.add("flarum-mentions","forum/mentionables/formats/MentionFormat",ut);const lt=flarum.reg.get("core","common/components/Avatar");var ct=t.n(lt);const dt=flarum.reg.get("core","common/helpers/highlight");var ft=t.n(dt);class pt{constructor(t){X(this,"format",void 0),this.format=t}}flarum.reg.add("flarum-mentions","forum/mentionables/MentionableModel",pt);const ht=flarum.reg.get("core","common/utils/extractText");var gt=t.n(ht);const bt=()=>gt()(s().translator.trans("core.lib.username.deleted_text"));function yt(t,e){return void 0===e&&(e=!0),t?((e?t.displayName():t.username())||bt()).replace(/"#[a-z]{0,3}[0-9]+/,"_"):bt().replace(/"#[a-z]{0,3}[0-9]+/,"_")}flarum.reg.add("flarum-mentions","forum/utils/getCleanDisplayName",yt);class vt extends pt{type(){return"user"}initialResults(){return Array.from(s().store.all("users"))}replacement(t){if(s().forum.attribute("allowUsernameMentionFormat")){const e=yt(t,!1);return this.format.format(e)}const e=yt(t);return this.format.format(e,"",t.id())}suggestion(t,e){const n=x()(t,(t=>ft()(t,e)));return m("[",null,m(ct(),{user:t}),n)}matches(t,e){return!!e&&[t.username(),t.displayName()].some((t=>t.toLowerCase().substr(0,e.length)===e))}maxStoreMatchedResults(){return null}async search(t){return await s().store.find("users",{filter:{q:t},page:{limit:5}})}enabled(){return!0}}flarum.reg.add("flarum-mentions","forum/mentionables/UserMention",vt);class wt extends pt{type(){return"post"}initialResults(){const t=flarum.reg.checkModule("core","forum/components/EditPostComposer"),e=flarum.reg.checkModule("core","forum/components/ReplyComposer");if(!(e&&s().composer.bodyMatches(e)||t&&s().composer.bodyMatches(t)))return[];const n=s().composer.body.attrs,o=n.post;return(o&&o.discussion()||n.discussion).posts().filter((t=>t&&"comment"===t.contentType()&&(!o||t.number()<o.number()))).sort(((t,e)=>e.createdAt().getTime()-t.createdAt().getTime()))}replacement(t){const e=yt(t.user());return this.format.format(e,"p",t.id())}suggestion(t,e){var n;const o=t.user()||null,i=x()(o,(t=>ft()(t,e)));return m("[",null,m(ct(),{user:o}),i,[s().translator.trans("flarum-mentions.forum.composer.reply_to_post_text",{number:t.number()})," — ",(0,r.truncate)(null!=(n=t.contentPlain())?n:"",200)])}matches(t,e){const n=t.user(),o=s().mentionFormats.mentionable("user");return!e||n&&o.matches(n,e)}maxStoreMatchedResults(){return 5}search(t){return Promise.resolve([])}enabled(){return!0}}flarum.reg.add("flarum-mentions","forum/mentionables/PostMention",wt);const Mt=flarum.reg.get("core","common/models/Group");var xt=t.n(Mt);const Pt=flarum.reg.get("core","common/components/Badge");var Ct=t.n(Pt);class Tt extends pt{type(){return"group"}initialResults(){return Array.from(s().store.all("groups").filter((t=>t.id()!==xt().GUEST_ID&&t.id()!==xt().MEMBER_ID)))}replacement(t){return this.format.format(t.namePlural(),"g",t.id())}suggestion(t,e){let n=t.namePlural();return e&&(n=ft()(n,e)),m("[",null,m(Ct(),{className:"Avatar Badge Badge--group--".concat(t.id()," Badge-icon"),color:t.color(),type:"group",icon:t.icon()}),m("span",{className:"username"},n))}matches(t,e){return!!e&&[t.namePlural().toLowerCase(),t.nameSingular().toLowerCase()].some((t=>t.toLowerCase().substr(0,e.length)===e))}maxStoreMatchedResults(){return null}search(t){return Promise.resolve([])}enabled(){var t,e,n;return null!=(t=null==(e=s().session)||null==(n=e.user)?void 0:n.canMentionGroups())&&t}}flarum.reg.add("flarum-mentions","forum/mentionables/GroupMention",Tt);class At extends ut{constructor(){super(...arguments),X(this,"mentionables",[vt,wt,Tt]),X(this,"extendable",!0)}trigger(){return"@"}queryFromTyped(t){const e=t.match(/^["“]?((?:(?!"#).)+)$/);return e?e[1]:null}format(t,e,n){return void 0===e&&(e=""),void 0===n&&(n=null),{simple:"@".concat(t),safe:'@"'.concat(t,'"#').concat(e).concat(n)}[n?"safe":"simple"]}}flarum.reg.add("flarum-mentions","forum/mentionables/formats/AtMentionFormat",At);class Bt extends pt{type(){return"tag"}initialResults(){return Array.from(s().store.all("tags"))}replacement(t){return this.format.format(t.slug())}matches(t,e){return!!e&&[t.name().toLowerCase()].some((t=>t.toLowerCase().substr(0,e.length)===e))}maxStoreMatchedResults(){return null}async search(t){return await s().store.find("tags",{filter:{q:t},page:{limit:5}})}suggestion(t,e){let n=t.name();return e&&(n=ft()(n,e)),m("[",null,m(Ct(),{className:"Avatar",icon:t.icon(),color:t.color(),type:"tag"}),m("span",{className:"username"},n))}enabled(){return"flarum-tags"in flarum.extensions}}flarum.reg.add("flarum-mentions","forum/mentionables/TagMention",Bt);class $t extends ut{constructor(){super(...arguments),X(this,"mentionables",[Bt]),X(this,"extendable",!0)}trigger(){return"#"}queryFromTyped(t){const e=t.match(/^[-_\p{L}\p{N}\p{M}]+$/giu);return e?e[0]:null}format(t){return"#".concat(t)}}flarum.reg.add("flarum-mentions","forum/mentionables/formats/HashMentionFormat",$t);class _t{constructor(){X(this,"formats",[new At,new $t])}get(t){var e;return null!=(e=this.formats.find((e=>e.trigger()===t)))?e:null}mentionable(t){for(const e of this.formats){const n=e.getMentionable(t);if(n)return n}return null}extend(t){this.formats.push(new t)}}flarum.reg.add("flarum-mentions","forum/mentionables/formats/MentionFormats",_t);const Nt=flarum.reg.get("core","forum/components/UserPage");var St=t.n(Nt);const kt=flarum.reg.get("core","common/components/LinkButton");var Ft=t.n(kt);const It=flarum.reg.get("core","common/extenders");var Lt=t.n(It);const Rt=flarum.reg.get("core","common/models/Post");var Dt=t.n(Rt);const Ut=flarum.reg.get("core","common/models/User");var jt=t.n(Ut);const Et=flarum.reg.get("core","forum/components/PostsUserPage");var Ht=t.n(Et);class Gt extends(Ht()){loadResults(t){return s().store.find("posts",{filter:{type:"comment",mentioned:this.user.id()},page:{offset:t,limit:this.loadLimit},sort:"-createdAt"})}}flarum.reg.add("flarum-mentions","forum/components/MentionsUserPage",Gt);const Wt=[(new(Lt().Routes)).add("user.mentions","/u/:username/mentions",Gt),new(Lt().Model)(Dt()).hasMany("mentionedBy").attribute("mentionedByCount"),new(Lt().Model)(jt()).attribute("canMentionGroups")];function qt(t){let e;if(s().forum.attribute("allowUsernameMentionFormat")&&t.hasAttribute("username")?e=s().store.getBy("users","username",t.getAttribute("username")):t.hasAttribute("id")&&(e=s().store.getById("users",t.getAttribute("id"))),e)return t.setAttribute("id",e.id()),t.setAttribute("slug",e.slug()),t.setAttribute("displayname",gt()(x()(e))),!0;t.invalidate()}function Ot(t){t.setAttribute("deleted",!1)}function Jt(t){const e=s().store.getById("posts",t.getAttribute("id"));if(e)return t.setAttribute("discussionid",e.discussion().id()),t.setAttribute("number",e.number()),t.setAttribute("displayname",gt()(x()(e.user()))),!0}function zt(t){t.setAttribute("deleted",!1)}function Qt(t){var e,n;if(null!=(e=s().session)&&null!=(n=e.user)&&n.canMentionGroups()){const e=s().store.getById("groups",t.getAttribute("id"));if(e)return t.setAttribute("groupname",gt()(e.namePlural())),!0}t.invalidate()}function Xt(t){var e,n;if(null!=(e=s().session)&&null!=(n=e.user)&&n.canMentionGroups()){const e=s().store.getById("groups",t.getAttribute("id"));t.setAttribute("color",e.color()),t.setAttribute("icon",e.icon()),t.setAttribute("deleted",!1)}}function Yt(t){if("flarum-tags"in flarum.extensions){const e=s().store.getBy("tags","slug",t.getAttribute("slug"));if(e)return t.setAttribute("id",e.id()),t.setAttribute("tagname",e.name()),!0}t.invalidate()}function Kt(t){if("flarum-tags"in flarum.extensions){const e=s().store.getBy("tags","slug",t.getAttribute("slug"));t.setAttribute("icon",e.icon()),t.setAttribute("color",e.color()),t.setAttribute("deleted",!1)}}flarum.reg.add("flarum-mentions","forum/utils/textFormatter",{filterUserMentions:qt,postFilterUserMentions:Ot,filterPostMentions:Jt,postFilterPostMentions:zt,filterGroupMentions:Qt,postFilterGroupMentions:Xt,filterTagMentions:Yt,postFilterTagMentions:Kt}),flarum.reg.add("flarum-mentions","forum/extenders/Mentionables",class{constructor(){X(this,"formats",[]),X(this,"mentionables",{})}format(t){return this.formats.push(t),this}mentionable(t,e){return this.mentionables[t]||(this.mentionables[t]=[]),this.mentionables[t].push(e),this}extend(t){for(const e of this.formats)t.mentionFormats.extend(e);for(const e in this.mentionables){const n=t.mentionFormats.get(e);if(n)for(const t of this.mentionables[e])n.extend(t)}}}),s().mentionFormats=new _t,s().initializers.add("flarum-mentions",(function(){!function(){function t(){const t=this.attrs.post.contentHtml();if(t===this.oldPostContentHtml||this.isEditing())return;this.oldPostContentHtml=t;const e=this.attrs.post,n=this.$();this.$().on("click",".UserMention:not(.UserMention--deleted), .PostMention:not(.PostMention--deleted), .TagMention:not(.TagMention--deleted)",(function(t){m.route.set(this.getAttribute("href")),t.preventDefault()})),this.$(".PostMention:not(.PostMention--deleted)").each((function(){const t=$(this),o=t.data("id");let s;const r=$('<ul class="Dropdown-menu PostMention-preview fade"/>');n.append(r);const i=()=>$('.PostStream-item[data-id="'.concat(o,'"]')),a=()=>{const s=i();let a=!1;if(s.length){const t=s.offset().top,e=window.pageYOffset;t>e&&t+s.height()<e+$(window).height()&&(s.addClass("pulsate"),a=!0)}if(!a){const s=()=>{const e=r.outerHeight(!0);let o=0;t.offset().top-e<$(window).scrollTop()+$("#header").outerHeight()?o+=t.outerHeight(!0):o-=e,r.show().css("top",t.offset().top-n.offset().top+o).css("left",t.offsetParent().offset().left-n.offset().left).css("max-width",t.offsetParent().width())},i=t=>{const n=t.discussion();m.render(r[0],[n!==e.discussion()&&m("li",null,m("span",{className:"PostMention-preview-discussion"},n.title())),m("li",null,m(p(),{post:t}))]),s()},a=app.store.getById("posts",o);a&&a.discussion()?i(a):(m.render(r[0],m(g(),null)),app.store.find("posts",o).then(i),s()),setTimeout((()=>r.off("transitionend").addClass("in")))}},u=()=>{i().removeClass("pulsate"),r.hasClass("in")&&r.removeClass("in").one("transitionend",(()=>r.hide()))};t.on("touchend",(t=>{t.cancelable&&t.preventDefault()})),t.add(r).hover((()=>{clearTimeout(s),s=setTimeout(a,250)}),(()=>{clearTimeout(s),i().removeClass("pulsate"),s=setTimeout(u,250)})).on("touchend",(t=>{a(),t.stopPropagation()})),$(document).on("touchend",u)}))}(0,n.extend)(d().prototype,"oncreate",t),(0,n.extend)(d().prototype,"onupdate",t)}(),function(){function t(){this.$(".Post-mentionedBy-preview").removeClass("in").one("transitionend",(function(){$(this).hide()}))}(0,n.extend)(d().prototype,"oncreate",(function(){let e;const n=this.attrs.post,o=n.mentionedBy();if(o&&o.length){const r=$('<ul class="Dropdown-menu Post-mentionedBy-preview fade"/>');this.$().append(r);const i=this.$(),a=this.$(".Post-mentionedBy"),u=()=>{!r.hasClass("in")&&r.is(":visible")||(m.render(r[0],m("[",null,o.map((e=>m("li",{"data-number":e.number()},m(p(),{post:e,onclick:t.bind(this)})))),o.length<n.mentionedByCount()&&m("li",{className:"Post-mentionedBy-preview-more"},m(A(),{className:"PostPreview Button",onclick:()=>{t.call(this),s().modal.show(L,{post:n})}},m("span",{className:"PostPreview-content"},m("span",{className:"PostPreview-badge Avatar"},m(C(),{name:"fas fa-reply-all"})),m("span",null,s().translator.trans("flarum-mentions.forum.post.mentioned_by_more_text",{count:n.mentionedByCount()-o.length}))))))),r.show().css("top",a.offset().top-i.offset().top+a.outerHeight(!0)).css("left",a.offsetParent().offset().left-i.offset().left).css("max-width",i.width()),setTimeout((()=>r.off("transitionend").addClass("in"))))};a.add(r).hover((()=>{clearTimeout(e),e=setTimeout(u,250)}),(()=>{clearTimeout(e),e=setTimeout(t,250)})),this.$().find(".Post-mentionedBy-summary a").hover((function(){r.find('[data-number="'+$(this).data("number")+'"]').addClass("active")}),(function(){r.find("[data-number]").removeClass("active")}))}})),(0,n.extend)(d().prototype,"footerItems",(function(e){const n=this.attrs.post,o=n.mentionedBy();if(o&&o.length){const r=[],i=o.sort((t=>t.user()===s().session.user?-1:0)).filter((t=>{const e=t.user();if(-1===r.indexOf(e))return r.push(e),!0})),a=4,u=n.mentionedByCount()>a,l=i.slice(0,u?a-1:a).map((e=>{const n=e.user();return m(y(),{href:s().route.post(e),onclick:t.bind(this),"data-number":e.number()},s().session.user===n?s().translator.trans("flarum-mentions.forum.post.you_text"):x()(n))}));if(u){const t=n.mentionedByCount()-l.length;l.push(s().translator.trans("flarum-mentions.forum.post.others_text",{count:t}))}e.add("replies",m("div",{className:"Post-mentionedBy"},m("span",{className:"Post-mentionedBy-summary"},m(C(),{name:"fas fa-reply"}),s().translator.trans("flarum-mentions.forum.post.mentioned_by".concat(i[0].user()===s().session.user?"_self":"","_text"),{count:l.length,users:w()(l)}))))}}))}(),(0,n.extend)(d().prototype,"actionItems",(function(t){const e=this.attrs.post;e.isHidden()||s().session.user&&!e.discussion().canReply()||t.add("reply",m(A(),{className:"Button Button--link",onclick:()=>j(e)},s().translator.trans("flarum-mentions.forum.post.reply_link")))})),(0,n.extend)(d().prototype,"oncreate",(function(){const t=this.attrs.post;if(t.isHidden()||s().session.user&&!t.discussion().canReply())return;const e=this.$(".Post-body"),n=$('<div class="Post-quoteButtonContainer"></div>'),o=new G(t),r=function(t){setTimeout((()=>{const s=W(e);if(s){o.content=s,m.render(n[0],o.render());const e=window.getSelection().getRangeAt(0).getClientRects(),r=e[0];if(t.clientY<r.bottom&&t.clientX-r.right<r.left-t.clientX)o.showStart(r.left,r.top);else{const t=e[e.length-1];o.showEnd(t.right,t.bottom)}}}),1)};this.$().after(n).on("mouseup",r),"ontouchstart"in window&&document.addEventListener("selectionchange",r,!1)})),function(){const t=$('<div class="ComposerBody-mentionsDropdownContainer"></div>'),e=new Y;(0,n.extend)("flarum/common/components/TextEditor","onbuild",(function(){const n=this.$(".TextEditor-editor").wrap('<div class="ComposerBody-mentionsWrapper"></div>');this.navigator=new(z()),this.navigator.when((()=>e.active)).onUp((()=>e.navigate(-1))).onDown((()=>e.navigate(1))).onSelect(e.complete.bind(e)).onCancel(e.hide.bind(e)).bindTo(n),n.after(t)})),(0,n.extend)("flarum/common/components/TextEditor","buildEditorParams",(function(n){let o,r,i,a=new ot({onmouseenter:function(){e.setIndex($(this).parent().index())},onclick:t=>{this.attrs.composer.editor.replaceBeforeCursor(r-1,t+" "),e.hide()}});n.inputListeners.push((()=>{const n=this.attrs.composer.editor.getSelectionRange(),u=n[0];if(n[1]-u>0)return;const l=this.attrs.composer.editor.getLastNChars(30);r=0;let c=null;for(let t=l.length-1;t>=0;t--){const e=l.substr(t,1);if(c=s().mentionFormats.get(e),c&&(0===t||/\s/.test(l.substr(t-1,1)))){o=t+1,r=u-l.length+t+1,a.init(c.makeMentionables());break}}if(e.hide(),e.active=!1,r){var d;const n=l.substring(o).toLowerCase();if(i=c.queryFromTyped(n),!i)return;a.typed=i;const s=()=>{const n=a.buildSuggestions();if(n.length){e.items=n,m.render(t[0],e.render()),e.show();const o=this.attrs.composer.editor.getCaretCoordinates(r),s=e.$().outerWidth(),i=e.$().outerHeight(),a=e.$().offsetParent();let u=o.left,l=o.top+15;l+i>a.height()&&(l=o.top-i-15),u+s>a.width()&&(u=a.width()-s),l=Math.max(-(a.offset().top-$(document).scrollTop()),l),u=Math.max(-a.offset().left,u),e.show(u,l)}else e.active=!1,e.hide()};e.active=!0,s(),e.setIndex(0),e.$().scrollTop(0),null==(d=a.search())||d.then(s)}}))})),(0,n.extend)("flarum/common/components/TextEditor","toolbarItems",(function(t){t.add("mention",m(O(),{onclick:()=>this.attrs.composer.editor.insertAtCursor(" @"),icon:"fas fa-at"},s().translator.trans("flarum-mentions.forum.composer.mention_tooltip")))}))}(),s().notificationComponents.postMentioned=it,s().notificationComponents.userMentioned=at,s().notificationComponents.groupMentioned=mt,(0,n.extend)("flarum/forum/components/NotificationGrid","notificationTypes",(function(t){t.add("postMentioned",{name:"postMentioned",icon:"fas fa-reply",label:s().translator.trans("flarum-mentions.forum.settings.notify_post_mentioned_label")}),t.add("userMentioned",{name:"userMentioned",icon:"fas fa-at",label:s().translator.trans("flarum-mentions.forum.settings.notify_user_mentioned_label")}),t.add("groupMentioned",{name:"groupMentioned",icon:"fas fa-at",label:s().translator.trans("flarum-mentions.forum.settings.notify_group_mentioned_label")})})),(0,n.extend)(St().prototype,"navItems",(function(t){const e=this.user;t.add("mentions",m(Ft(),{href:s().route("user.mentions",{username:e.slug()}),name:"mentions",icon:"fas fa-at"},s().translator.trans("flarum-mentions.forum.user.mentions_link")),80)})),r.getPlainContent.removeSelectors.push("a.PostMention"),(0,n.extend)(l().prototype,"oncreate",(function(){this.$(".GroupMention--colored, .TagMention--colored").each((function(){this.classList.add(a()(getComputedStyle(this).getPropertyValue("--color")))}))}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map