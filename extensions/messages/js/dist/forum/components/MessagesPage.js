"use strict";(self.webpackChunkmodule_exports=self.webpackChunkmodule_exports||[]).push([[301],{684:(e,s,t)=>{t.d(s,{A:()=>y});var a=t(488),r=t.n(a),o=t(950),i=t.n(o),l=t(336),n=t.n(l),d=t(443),c=t.n(d),u=t(88),g=t.n(u),h=t(917),p=t.n(h),f=t(521),v=t.n(f),b=t(167),N=t.n(b),_=t(906),M=t.n(_);class A extends(i()){view(e){const s=this.attrs.dialog,t=s.recipient(),a=s.lastMessage();return m("li",{className:c()("DialogListItem",{"DialogListItem--unread":s.unreadCount(),active:this.attrs.active})},m(g(),{href:r().route.dialog(s),className:c()("DialogListItem-button",{active:this.attrs.active})},m("div",{className:"DialogListItem-avatar"},m(p(),{user:t}),!!s.unreadCount()&&m("div",{className:"Bubble Bubble--primary"},s.unreadCount())),m("div",{className:"DialogListItem-content"},m("div",{className:"DialogListItem-title"},v()(t),N()(s.lastMessageAt()),this.attrs.actions&&m("div",{className:"DialogListItem-actions"},this.actionItems().toArray())),m("div",{className:"DialogListItem-lastMessage"},a?a.contentPlain()?.slice(0,80):""))))}actionItems(){const e=new(M());return e.add("markAsRead",m(n(),{className:"Notification-action Button Button--link",icon:"fas fa-check","aria-label":r().translator.trans("flarum-messages.forum.dialog_list.mark_as_read_tooltip"),onclick:e=>{e.preventDefault(),e.stopPropagation(),this.attrs.dialog.save({lastReadMessageId:(this.attrs.dialog.data.relationships?.lastMessage.data).id}).finally((()=>{0===this.attrs.dialog.unreadCount()&&r().session.user.pushAttributes({messageCount:(r().session.user.attribute("messageCount")??1)-1}),m.redraw()}))}}),100),e}}flarum.reg.add("flarum-messages","forum/components/DialogListItem",A);class y extends(i()){oninit(e){super.oninit(e)}oncreate(e){super.oncreate(e)}onupdate(e){super.onupdate(e)}view(){return m("div",{className:"DialogList"},m("ul",{className:"DialogList-list"},this.attrs.state.getAllItems().map((e=>m(A,{dialog:e,active:this.attrs.activeDialog?.id()===e.id(),actions:this.attrs.itemActions})))),this.attrs.state.hasNext()&&!this.attrs.hideMore&&m("div",{className:"DialogList-loadMore"},m(n(),{className:"Button",onclick:this.attrs.state.loadNext.bind(this.attrs.state)},r().translator.trans("flarum-messages.forum.dialog_list.load_more_button"))))}}flarum.reg.add("flarum-messages","forum/components/DialogList",y)},654:(e,s,t)=>{t.r(s),t.d(s,{default:()=>me});var a=t(805),r=t(488),o=t.n(r),i=t(859),l=t.n(i),n=t(314),d=t.n(n),c=t(801),u=t.n(c),g=t(684),h=t(661),p=t.n(h),f=t(821),v=t.n(f),b=t(500),N=t.n(b),_=t(402),M=t.n(_),A=t(336),y=t.n(A);class I extends(M()){static initAttrs(e){e.className="MessagesPage-nav"}items(){const e=super.items(),s=o().session.user.attribute("canSendAnyMessage");return e.remove("newDiscussion"),e.add("newMessage",m(y(),{icon:"fas fa-edit",className:"Button Button--primary IndexPage-newDiscussion MessagesPage-newMessage",itemClassName:"App-primaryControl",onclick:()=>this.newMessageAction(),disabled:!s},o().translator.trans("flarum-messages.forum.messages_page.new_message_button")),10),e}newMessageAction(){return flarum.reg.asyncModuleImport("flarum/forum/components/ComposerBody").then((()=>(o().composer.load((()=>t.e(451).then(t.bind(t,761))),{user:o().session.user,onsubmit:()=>{o().dialogs.refresh()}}).then((()=>o().composer.show())),o().composer)))}}flarum.reg.add("flarum-messages","forum/components/MessagesSidebar",I);var k=t(950),D=t.n(k),w=t(476),P=t.n(w),S=t(906),T=t.n(S),B=t(154),L=t.n(B),x=t(917),C=t.n(x),R=t(3),H=t.n(R),j=t(651),q=t.n(j),G=t(301),O=t.n(G),E=t(443),F=t.n(E);class V extends(L()){oninit(e){super.oninit(e)}user(){return this.attrs.message.user()}controls(){return[]}freshness(){return this.attrs.message.freshness}createdByStarter(){return!1}onbeforeupdate(e){return super.onbeforeupdate(e)}onupdate(e){super.onupdate(e)}elementAttrs(){const e=this.attrs.message,s=super.elementAttrs();return s.className=F()(s.className||null,"Message",{"Post--renderFailed":e.renderFailed(),revealContent:!1,editing:!1}),s}header(){return super.header()}content(){return super.content().concat([m(H(),{headerItems:this.headerItems(),cardVisible:!1,isEditing:!1,isHidden:!1,contentHtml:this.attrs.message.contentHtml(),user:this.attrs.message.user()})])}classes(e){return super.classes(e)}actionItems(){return super.actionItems()}footerItems(){return super.footerItems()}sideItems(){return super.sideItems()}avatar(){return this.attrs.message.user()?m(C(),{user:this.attrs.message.user()}):""}headerItems(){const e=new(T()),s=this.attrs.message;return e.add("user",m(q(),{post:s}),100),e.add("meta",m(O(),{post:s})),e}}flarum.reg.add("flarum-messages","forum/components/Message",V);class z extends(D()){constructor(){super(...arguments),(0,a.A)(this,"replyPlaceholderComponent",v()(null)),(0,a.A)(this,"loadingPostComponent",v()(null)),(0,a.A)(this,"scrollListener",void 0),(0,a.A)(this,"initialToBottomScroll",!1),(0,a.A)(this,"lastTime",null),(0,a.A)(this,"checkedRead",!1),(0,a.A)(this,"markingAsRead",!1)}oninit(e){super.oninit(e),Promise.all([flarum.reg.asyncModuleImport("flarum/forum/components/ReplyPlaceholder"),flarum.reg.asyncModuleImport("flarum/forum/components/LoadingPost")]).then((e=>{let[s,t]=e;this.replyPlaceholderComponent(s.default),this.loadingPostComponent(t.default)}))}oncreate(e){super.oncreate(e),this.scrollListener=new(P())(this.onscroll.bind(this),this.element),setTimeout((()=>{this.scrollListener.start(),this.element.addEventListener("scrollend",this.markAsRead.bind(this))}))}onupdate(e){super.onupdate(e),this.initialToBottomScroll||this.attrs.state.isLoading()||(this.scrollToBottom(),this.initialToBottomScroll=!0),this.initialToBottomScroll&&!this.checkedRead&&(this.markAsRead(),this.checkedRead=!0)}onremove(e){super.onremove(e),this.scrollListener.stop()}view(){return m("div",{className:"MessageStream"},this.attrs.state.isLoading()?m(p(),null):this.content())}content(){const e=[],s=this.attrs.state.getAllItems().sort(((e,s)=>e.createdAt().getTime()-s.createdAt().getTime())),a=this.replyPlaceholderComponent(),r=this.loadingPostComponent();return s[0].id()!==(this.attrs.dialog.data.relationships?.firstMessage.data).id&&(e.push(m("div",{className:"MessageStream-item",key:"loadPrevious"},m(y(),{onclick:()=>this.whileMaintainingScroll((()=>this.attrs.state.loadNext())),type:"button",className:"Button Button--block MessageStream-loadPrev"},o().translator.trans("flarum-messages.forum.messages_page.stream.load_previous_button")))),r&&e.push(m("div",{className:"MessageStream-item",key:"loading-prev"},m(r,null)))),s.forEach(((s,t)=>e.push(this.messageItem(s,t)))),a&&e.push(m("div",{className:"MessageStream-item",key:"reply"},m(a,{discussion:this.attrs.dialog,onclick:()=>{flarum.reg.asyncModuleImport("flarum/forum/components/ComposerBody").then((()=>{o().composer.load((()=>t.e(451).then(t.bind(t,761))),{user:o().session.user,replyingTo:this.attrs.dialog,onsubmit:()=>{this.attrs.state.refresh().then((()=>setTimeout((()=>this.scrollToBottom()),50)))}}).then((()=>o().composer.show()))}))},composingReply:()=>o().composer.composingMessageTo(this.attrs.dialog)}))),e}messageItem(e,s){return m("div",{className:"MessageStream-item",key:s,"data-id":e.id()},this.timeGap(e),m(V,{message:e}))}timeGap(e){if(e.id()===(this.attrs.dialog.data.relationships?.firstMessage.data).id)return this.lastTime=e.createdAt(),m("div",{class:"PostStream-timeGap"},m("span",null,o().translator.trans("flarum-messages.forum.messages_page.stream.start_of_the_conversation")));const s=this.lastTime,t=e.createdAt().getTime()-(s?.getTime()||0);return this.lastTime=e.createdAt(),s&&t>3456e5?m("div",{className:"PostStream-timeGap"},m("span",null,o().translator.trans("flarum-messages.forum.messages_page.stream.time_lapsed_text",{period:dayjs().add(t,"ms").fromNow(!0)}))):null}onscroll(){this.whileMaintainingScroll((()=>this.element.scrollTop<=80&&this.attrs.state.hasNext()?this.attrs.state.loadNext():this.element.scrollTop+this.element.clientHeight===this.element.scrollHeight&&this.attrs.state.hasPrev()?this.attrs.state.loadPrev():null))}scrollToBottom(){this.element.scrollTop=this.element.scrollHeight}whileMaintainingScroll(e){const s=this.element.scrollTop,t=this.element.scrollHeight,a=e();a instanceof Promise&&a.then((()=>{requestAnimationFrame((()=>{this.element.scrollTop=this.element.scrollHeight-t+s}))}))}markAsRead(){const e=Number(this.$(".MessageStream-item[data-id]").filter(((e,s)=>this.element.scrollHeight<=this.element.clientHeight||this.$().offset().top+this.element.clientHeight>$(s).offset().top)).last().data("id"));e&&o().session.user&&e>(this.attrs.dialog.lastReadMessageId()||0)&&!this.markingAsRead&&(this.markingAsRead=!0,this.attrs.dialog.save({lastReadMessageId:e}).finally((()=>{this.markingAsRead=!1,0===this.attrs.dialog.unreadCount()&&o().session.user.pushAttributes({messageCount:(o().session.user.attribute("messageCount")??1)-1}),m.redraw()})))}}flarum.reg.add("flarum-messages","forum/components/MessageStream",z);var J=t(521),K=t.n(J),Q=t(662),U=t.n(Q);class W extends(U()){constructor(e,s){void 0===s&&(s=1),super(e,s,null)}get type(){return"dialog-messages"}getAllItems(){return super.getAllItems()}}flarum.reg.add("flarum-messages","forum/states/MessageStreamState",W);var X=t(88),Y=t.n(X),Z=t(741),ee=t.n(Z),se=t(533),te=t.n(se),ae=t(653),re=t.n(ae),oe=t(819),ie=t.n(oe);class le extends(te()){className(){return"Modal--small Modal--flat DetailsModal"}title(){return o().translator.trans("flarum-messages.forum.dialog_section.details_modal.title")}content(){let e=(this.attrs.dialog.users()||[]).filter(Boolean);return m("div",{className:"Modal-body DetailsModal-infoGroups"},m("div",{className:"DetailsModal-recipients DetailsModal-info"},m("div",{className:"DetailsModal-info-title"},o().translator.trans("flarum-messages.forum.dialog_section.details_modal.recipients")),m("div",{className:"DetailsModal-recipients-list"},e?.map((e=>m("div",{className:"DetailsModal-recipient"},m(C(),{user:e}),m(Y(),{href:o().route("user",{username:e.slug()})},m("span",{className:"DetailsModal-recipient-username"},K()(e))),m("div",{className:"badges"},ie()(e.badges().toArray()))))))),this.infoItems().toArray())}infoItems(){const e=new(T());return e.add("created",m("div",{className:"DetailsModal-createdAt DetailsModal-info"},m("div",{className:"DetailsModal-info-title"},o().translator.trans("flarum-messages.forum.dialog_section.details_modal.created_at")),m("div",{className:"DetailsModal-info-content"},re()(this.attrs.dialog.createdAt())))),e}}flarum.reg.add("flarum-messages","forum/components/DetailsModal",le);class ne extends(D()){constructor(){super(...arguments),(0,a.A)(this,"loading",!1),(0,a.A)(this,"messages",void 0)}oninit(e){super.oninit(e),this.messages=new W({filter:{dialog:this.attrs.dialog.id()},sort:"-createdAt"}),this.messages.refresh()}view(){const e=this.attrs.dialog.recipient();return m("div",{className:"DialogSection"},m("div",{className:"DialogSection-header"},m(C(),{user:e}),m("div",{className:"DialogSection-header-info"},e&&m(Y(),{href:o().route.user(e)},m("h2",null,K()(e)))||m("h2",null,K()(e)),m("div",{className:"badges"},ie()(e?.badges().toArray()||[]))),m("div",{className:"DialogSection-header-actions"},this.actionItems().toArray())),m(z,{dialog:this.attrs.dialog,state:this.messages}))}actionItems(){const e=new(T());return e.add("details",m(ee(),{icon:"fas fa-ellipsis-h",className:"DialogSection-controls",buttonClassName:"Button Button--icon",accessibleToggleLabel:o().translator.trans("flarum-messages.forum.dialog_section.controls_toggle_label"),label:o().translator.trans("flarum-messages.forum.dialog_section.controls_toggle_label")},this.controlItems().toArray())),e}controlItems(){const e=new(T());return e.add("details",m(y(),{icon:"fas fa-info-circle",onclick:()=>o().modal.show(le,{dialog:this.attrs.dialog})},o().translator.trans("flarum-messages.forum.dialog_section.controls.details_button"))),e}}flarum.reg.add("flarum-messages","forum/components/DialogSection",ne);class me extends(l()){constructor(){super(...arguments),(0,a.A)(this,"selectedDialog",v()(null))}oninit(e){super.oninit(e),o().session.user?(o().current.set("noTagsList",!0),o().dialogs.hasItems()?this.initDialog():o().dialogs.refresh().then((async()=>{o().dialogs.hasItems()&&await this.initDialog()}))):m.route.set(o().route("index"))}dialogRequestParams(){return{include:"users.groups"}}async initDialog(){const e=m.route.param("id"),s=o().translator.trans("flarum-messages.forum.messages_page.title",{},!0);let t;t=e?o().store.getById("dialogs",e)||await o().store.find("dialogs",e,this.dialogRequestParams()):o().dialogs.getAllItems()[0],this.selectedDialog(t),t?(o().setTitle(t.title()),o().history.push("dialog",t.title())):(o().setTitle(s),o().history.push("messages",s)),m.redraw()}onupdate(e){super.onupdate(e);const s=this.element.querySelector(".DialogListItem.active"),t=this.element.querySelector(".DialogList");s&&$(t).offset().top+t.clientHeight<=$(s).offset().top&&s.scrollIntoView()}view(){return m(d(),{className:"MessagesPage Page--vertical",loading:!1,hero:this.hero.bind(this),sidebar:()=>m(I,null)},o().dialogs.isLoading()?m(p(),null):o().dialogs.hasItems()?m("div",{className:"MessagesPage-content"},m("div",{className:"MessagesPage-sidebar",key:"sidebar"},m("div",{className:"IndexPage-toolbar",key:"toolbar"},m("ul",{className:"IndexPage-toolbar-view"},ie()(this.viewItems().toArray())),m("ul",{className:"IndexPage-toolbar-action"},ie()(this.actionItems().toArray()))),m(g.A,{key:"list",state:o().dialogs,activeDialog:this.selectedDialog()})),this.selectedDialog()?m(ne,{key:"dialog",dialog:this.selectedDialog()}):m(p(),{key:"loading",display:"block"})):m(N(),{icon:"far fa-envelope-open"},o().translator.trans("flarum-messages.forum.messages_page.empty_text")))}hero(){return m("header",{className:"Hero MessagesPageHero"},m("div",{className:"container"},m("div",{className:"containerNarrow"},m("h1",{className:"Hero-title"},m(u(),{name:"fas fa-envelope"})," ",o().translator.trans("flarum-messages.forum.messages_page.hero.title")),m("div",{className:"Hero-subtitle"},o().translator.trans("flarum-messages.forum.messages_page.hero.subtitle")))))}viewItems(){const e=new(T()),s=o().dialogs.sortMap(),t=Object.keys(s).reduce(((e,t)=>{const a=s[t];return e[t]="string"!=typeof a?a.label:o().translator.trans(`flarum-messages.forum.index_sort.${t}_button`),e}),{});return e.add("sort",m(ee(),{buttonClassName:"Button",label:t[o().dialogs.getParams()?.sort||0]||Object.values(t)[0],accessibleToggleLabel:o().translator.trans("core.forum.index_sort.toggle_dropdown_accessible_label")},Object.keys(t).map((e=>{const a=t[e],r=(o().dialogs.getParams().sort||Object.keys(s)[0])===e;return m(y(),{icon:!r||"fas fa-check",onclick:()=>o().dialogs.changeSort(e),active:r},a)})))),e}actionItems(){const e=new(T());return e.add("refresh",m(y(),{title:o().translator.trans("flarum-messages.forum.messages_page.refresh_tooltip"),"aria-label":o().translator.trans("flarum-messages.forum.messages_page.refresh_tooltip"),icon:"fas fa-sync",className:"Button Button--icon",onclick:()=>{o().dialogs.refresh()}})),o().session.user&&e.add("markAllAsRead",m(y(),{title:o().translator.trans("flarum-messages.forum.messages_page.mark_all_as_read_tooltip"),"aria-label":o().translator.trans("flarum-messages.forum.messages_page.mark_all_as_read_tooltip"),icon:"fas fa-check",className:"Button Button--icon",onclick:()=>o().dialogs.markAllAsRead()})),e}}flarum.reg.add("flarum-messages","forum/components/MessagesPage",me)}}]);
//# sourceMappingURL=MessagesPage.js.map