{"version":3,"file":"common/components/EditUserModal.js","mappings":"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","sources":["webpack://@flarum/core/./src/common/components/EditUserModal.tsx"],"sourcesContent":["import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport app from '../../common/app';\nimport FormModal from '../../common/components/FormModal';\nimport Button from './Button';\nimport GroupBadge from './GroupBadge';\nimport Group from '../models/Group';\nimport extractText from '../utils/extractText';\nimport ItemList from '../utils/ItemList';\nimport Stream from '../utils/Stream';\nimport Form from './Form';\nexport default class EditUserModal extends FormModal {\n  constructor() {\n    super(...arguments);\n    _defineProperty(this, \"username\", void 0);\n    _defineProperty(this, \"email\", void 0);\n    _defineProperty(this, \"isEmailConfirmed\", void 0);\n    _defineProperty(this, \"setPassword\", void 0);\n    _defineProperty(this, \"password\", void 0);\n    _defineProperty(this, \"groups\", {});\n  }\n  oninit(vnode) {\n    super.oninit(vnode);\n    const user = this.attrs.user;\n    this.username = Stream(user.username() || '');\n    this.email = Stream(user.email() || '');\n    this.isEmailConfirmed = Stream(user.isEmailConfirmed() || false);\n    this.setPassword = Stream(false);\n    this.password = Stream(user.password() || '');\n    const userGroups = user.groups() || [];\n    app.store.all('groups').filter(group => ![Group.GUEST_ID, Group.MEMBER_ID].includes(group.id())).forEach(group => this.groups[group.id()] = Stream(userGroups.includes(group)));\n  }\n  className() {\n    return 'EditUserModal Modal--small';\n  }\n  title() {\n    return app.translator.trans('core.lib.edit_user.title');\n  }\n  content() {\n    const fields = this.fields().toArray();\n    return m(\"div\", {\n      className: \"Modal-body\"\n    }, fields.length > 1 ? m(Form, null, this.fields().toArray()) : app.translator.trans('core.lib.edit_user.nothing_available'));\n  }\n  fields() {\n    const items = new ItemList();\n    if (this.attrs.user.canEditCredentials()) {\n      items.add('username', m(\"div\", {\n        className: \"Form-group\"\n      }, m(\"label\", null, app.translator.trans('core.lib.edit_user.username_heading')), m(\"input\", {\n        className: \"FormControl\",\n        placeholder: extractText(app.translator.trans('core.lib.edit_user.username_label')),\n        bidi: this.username,\n        disabled: this.nonAdminEditingAdmin()\n      })), 40);\n      if (app.session.user !== this.attrs.user) {\n        items.add('email', m(\"div\", {\n          className: \"Form-group\"\n        }, m(\"label\", null, app.translator.trans('core.lib.edit_user.email_heading')), m(\"input\", {\n          className: \"FormControl\",\n          placeholder: extractText(app.translator.trans('core.lib.edit_user.email_label')),\n          bidi: this.email,\n          disabled: this.nonAdminEditingAdmin()\n        }), !this.isEmailConfirmed() && this.userIsAdmin(app.session.user) && m(Button, {\n          className: \"Button Button--block\",\n          loading: this.loading,\n          onclick: this.activate.bind(this)\n        }, app.translator.trans('core.lib.edit_user.activate_button'))), 30);\n        items.add('password', m(\"div\", {\n          className: \"Form-group\"\n        }, m(\"label\", null, app.translator.trans('core.lib.edit_user.password_heading')), m(\"div\", null, m(\"label\", {\n          className: \"checkbox\"\n        }, m(\"input\", {\n          type: \"checkbox\",\n          onchange: e => {\n            const target = e.target;\n            this.setPassword(target.checked);\n            m.redraw.sync();\n            if (target.checked) this.$('[name=password]').select();\n            e.redraw = false;\n          },\n          disabled: this.nonAdminEditingAdmin()\n        }), app.translator.trans('core.lib.edit_user.set_password_label'))), this.setPassword() && m(\"input\", {\n          className: \"FormControl\",\n          type: \"password\",\n          name: \"password\",\n          placeholder: extractText(app.translator.trans('core.lib.edit_user.password_label')),\n          bidi: this.password,\n          disabled: this.nonAdminEditingAdmin()\n        })), 20);\n      }\n    }\n    if (this.attrs.user.canEditGroups()) {\n      items.add('groups', m(\"div\", {\n        className: \"Form-group EditUserModal-groups\"\n      }, m(\"label\", null, app.translator.trans('core.lib.edit_user.groups_heading')), m(\"div\", null, Object.keys(this.groups).map(id => app.store.getById('groups', id)).filter(Boolean).map(group =>\n      // Necessary because filter(Boolean) doesn't narrow out falsy values.\n      group && m(\"label\", {\n        className: \"checkbox\"\n      }, m(\"input\", {\n        type: \"checkbox\",\n        bidi: this.groups[group.id()],\n        disabled: group.id() === Group.ADMINISTRATOR_ID && (this.attrs.user === app.session.user || !this.userIsAdmin(app.session.user))\n      }), m(GroupBadge, {\n        group: group,\n        label: null\n      }), \" \", group.nameSingular())))), 10);\n    }\n    items.add('submit', m(\"div\", {\n      className: \"Form-group Form-controls\"\n    }, m(Button, {\n      className: \"Button Button--primary\",\n      type: \"submit\",\n      loading: this.loading\n    }, app.translator.trans('core.lib.edit_user.submit_button'))), -10);\n    return items;\n  }\n  activate() {\n    this.loading = true;\n    const data = {\n      username: this.username(),\n      isEmailConfirmed: true\n    };\n    this.attrs.user.save(data, {\n      errorHandler: this.onerror.bind(this)\n    }).then(() => {\n      this.isEmailConfirmed(true);\n      this.loading = false;\n      m.redraw();\n    }).catch(() => {\n      this.loading = false;\n      m.redraw();\n    });\n  }\n  data() {\n    const data = {};\n    const relationships = {};\n    if (this.attrs.user.canEditCredentials() && !this.nonAdminEditingAdmin()) {\n      data.username = this.username();\n      if (app.session.user !== this.attrs.user) {\n        data.email = this.email();\n      }\n      if (this.setPassword()) {\n        data.password = this.password();\n      }\n    }\n    if (this.attrs.user.canEditGroups()) {\n      relationships.groups = Object.keys(this.groups).filter(id => this.groups[id]()).map(id => app.store.getById('groups', id)).filter(g => g instanceof Group);\n    }\n    data.relationships = relationships;\n    return data;\n  }\n  onsubmit(e) {\n    e.preventDefault();\n    this.loading = true;\n    this.attrs.user.save(this.data(), {\n      errorHandler: this.onerror.bind(this)\n    }).then(this.hide.bind(this)).catch(() => {\n      this.loading = false;\n      m.redraw();\n    });\n  }\n  nonAdminEditingAdmin() {\n    return this.userIsAdmin(this.attrs.user) && !this.userIsAdmin(app.session.user);\n  }\n\n  /**\n   * @internal\n   */\n  userIsAdmin(user) {\n    return !!(user?.groups() || []).some(g => g?.id() === Group.ADMINISTRATOR_ID);\n  }\n}\nflarum.reg.add('core', 'common/components/EditUserModal', EditUserModal);"],"names":["EditUserModal","constructor","super","arguments","this","oninit","vnode","user","attrs","username","email","isEmailConfirmed","setPassword","password","userGroups","groups","store","all","filter","group","GUEST_ID","MEMBER_ID","includes","id","forEach","className","title","translator","trans","content","fields","toArray","m","length","items","canEditCredentials","add","placeholder","bidi","disabled","nonAdminEditingAdmin","session","userIsAdmin","loading","onclick","activate","bind","type","onchange","e","target","checked","redraw","sync","$","select","name","canEditGroups","Object","keys","map","getById","Boolean","ADMINISTRATOR_ID","label","nameSingular","data","save","errorHandler","onerror","then","catch","relationships","g","onsubmit","preventDefault","hide","some","flarum","reg"],"sourceRoot":""}