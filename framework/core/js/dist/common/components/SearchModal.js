"use strict";(self.webpackChunkflarum_core=self.webpackChunkflarum_core||[]).push([[485],{7085:(e,t,s)=>{s.r(t),s.d(t,{default:()=>A});var r=s(8805),a=s(5114),i=s(2855),o=s(6732),c=s(3920),n=s(117),u=s(7882),l=s(3092),h=s(4311),d=s(4164),p=s(43),v=s(6064),g=s(6500);class A extends i.A{constructor(){super(...arguments),(0,r.A)(this,"searchState",void 0),(0,r.A)(this,"query",void 0),(0,r.A)(this,"sources",void 0),(0,r.A)(this,"activeSource",void 0),(0,r.A)(this,"loadingSources",[]),(0,r.A)(this,"index",0),(0,r.A)(this,"navigator",void 0),(0,r.A)(this,"searchTimeout",void 0),(0,r.A)(this,"inputScroll",(0,h.A)(0)),(0,r.A)(this,"gambitsAutocomplete",{})}oninit(e){super.oninit(e),this.searchState=this.attrs.searchState,this.sources=this.attrs.sources,this.activeSource=(0,h.A)(this.defaultActiveSource()&&this.sources.find((e=>e.resource===this.defaultActiveSource()))||this.sources[0]),this.query=(0,h.A)(this.prefill(this.searchState.getValue()||"").trim())}title(){return a.A.translator.trans("core.lib.search.title")}className(){return"SearchModal Modal--flat"}content(){this.gambitsAutocomplete[this.activeSource().resource]||=new g.A(this.activeSource().resource,(()=>this.inputElement()),this.query,(e=>this.search(e)));const e=(0,n.A)(a.A.translator.trans("core.lib.search.placeholder"));return m("div",{className:"Modal-body SearchModal-body"},m("div",{className:"SearchModal-form"},m(u.A,{key:"search",type:"search",loading:!!this.loadingSources.length,clearable:!0,clearLabel:a.A.translator.trans("core.lib.header.search_clear_button_accessible_label"),prefixIcon:"fas fa-search","aria-label":e,placeholder:e,value:this.query(),onchange:e=>{this.query(e),this.inputScroll(this.inputElement()[0]?.scrollLeft??0)},inputAttrs:{className:"SearchModal-input"},renderInput:e=>m("[",null,m("input",Object.assign({},e,{onscroll:e=>this.inputScroll(e.target.scrollLeft)})),m("div",{className:"SearchModal-visual-wrapper"},m("div",{className:"SearchModal-visual-input",style:{left:"-"+this.inputScroll()+"px"}},this.gambifyInput())))})),this.tabs())}tabs(){return m("div",{className:"Tabs"},m("div",{className:"Tabs-nav"},this.tabItems().toArray()),m("div",{className:"Tabs-content SearchModal-tabs-content"},this.activeTabItems().toArray()))}tabItems(){const e=new v.A;return this.sources?.map(((t,s)=>e.add(t.resource,m(l.A,{className:"Button Button--link",active:this.activeSource()===t,onclick:()=>this.switchSource(t)},t.title()),100-s))),e}activeTabItems(){const e=new v.A,t=this.loadingSources.includes(this.activeSource().resource),s=!!this.query()&&!t,r=this.gambits(),i=this.activeSource().fullPage(this.query()),o=this.activeSource()?.view(this.query()),c=this.activeSource().customGrouping();return s&&i&&e.add("fullPageLink",m("div",{className:"SearchModal-section"},m("hr",{className:"Modal-divider"}),m("ul",{className:"Dropdown-menu SearchModal-fullPage"},i)),80),r.length&&e.add("gambits",m("div",{className:"SearchModal-section"},m("hr",{className:"Modal-divider"}),m("ul",{className:"Dropdown-menu SearchModal-options","aria-live":r.length?"polite":void 0},m("li",{className:"Dropdown-header"},a.A.translator.trans("core.lib.search.options_heading")),r)),60),e.add("results",m("div",{className:"SearchModal-section"},m("hr",{className:"Modal-divider"}),m("ul",{className:"Dropdown-menu SearchModal-results","aria-live":s?"polite":void 0},!c&&m("li",{className:"Dropdown-header"},a.A.translator.trans("core.lib.search.preview_heading")),!s&&m("li",{className:"Dropdown-message"},m(d.A,{icon:"fas fa-search"},a.A.translator.trans("core.lib.search.no_search_text"))),s&&o,s&&!o?.length&&m("li",{className:"Dropdown-message"},m(d.A,{icon:"far fa-tired"},a.A.translator.trans("core.lib.search.no_results_text"))),t&&m("li",{className:"Dropdown-message"},m(p.A,null)))),40),e}switchSource(e){this.activeSource()!==e&&(this.activeSource(e),this.search(this.query()),this.inputElement().focus(),m.redraw())}gambits(){return this.gambitsAutocomplete[this.activeSource().resource].suggestions(this.query())}gambifyInput(){const e=this.query();let t=e;a.A.search.gambits.match(this.activeSource().resource,e,((e,s,r,a)=>{t=t.replace(a,`<mark>${a}</mark>`)}));const s=[];return t.split(/(<mark>.*?<\/mark>)/).forEach((e=>{e.startsWith("<mark>")?s.push(m("mark",null,e.replace(/<\/?mark>/g,""))):s.push(e)})),s}onupdate(e){super.onupdate(e),this.setIndex(this.getCurrentNumericIndex());const t=this;this.$(".Dropdown-menu").on("mouseenter","> li:not(.Dropdown-header):not(.Dropdown-message)",(function(){t.setIndex(t.selectableItems().index(this))})),this.sources}oncreate(e){if(super.oncreate(e),!this.sources?.length)return;const t=this.search.bind(this);this.setIndex(this.getCurrentNumericIndex());const s=this.inputElement();this.navigator=new o.A,this.navigator.onUp((()=>this.setIndex(this.getCurrentNumericIndex()-1,!0))).onDown((()=>this.setIndex(this.getCurrentNumericIndex()+1,!0))).onSelect(this.selectResult.bind(this),!0).onCancel(this.clear.bind(this)).bindTo(s),s.on("input focus",(function(){t(this.value.toLowerCase())}))}onremove(e){this.searchState.setValue(this.query()),super.onremove(e)}search(e){if(!e)return;const t=this.activeSource();this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=window.setTimeout((()=>{if(!t.isCached(e)){if(e.length>=c.A.MIN_SEARCH_LEN){if(!t.search)return;this.loadingSources.push(t.resource),t.search(e,A.LIMIT).then((()=>{this.loadingSources=this.loadingSources.filter((e=>e!==t.resource)),m.redraw()}))}this.searchState.cache(e),m.redraw()}}),250)}selectResult(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.loadingSources=[];const e=this.getItem(this.index);let t=null;if(e.attr("data-id")){const s=e.attr("data-id");t=s&&this.activeSource().gotoItem(s)}else e.find("a").length&&(t=e.find("a").attr("href"));this.query()&&t?m.route.set(t):e.find("button")[0].click()}clear(){this.query("")}selectableItems(){return this.$(".Dropdown-menu > li:not(.Dropdown-header):not(.Dropdown-message)")}getCurrentNumericIndex(){return Math.max(0,this.selectableItems().index(this.getItem(this.index)))}getItem(e){const t=this.selectableItems();let s=t.filter(`[data-index="${e}"]`);return s.length||(s=t.eq(e)),s}setIndex(e,t){void 0===t&&(t=!1);const s=this.selectableItems(),r=s.parent();let a=e;e<0?a=s.length-1:e>=s.length&&(a=0);const i=s.removeClass("active").eq(a).addClass("active");if(this.index=parseInt(i.attr("data-index"))||a,t&&r){const e=r.scrollTop(),t=r.offset().top,s=t+r.outerHeight(),a=i.offset().top,o=a+i.outerHeight();let c;a<t?c=e-t+a-parseInt(r.css("padding-top"),10):o>s&&(c=e-s+o+parseInt(r.css("padding-bottom"),10)),void 0!==c&&r.stop(!0).animate({scrollTop:c},100)}}inputElement(){return this.$(".SearchModal-input")}defaultActiveSource(){const e=a.A.current.data.routeName&&["discussion","discussion.near"].includes(a.A.current.data.routeName)&&a.A.current.data.discussion,t=a.A.current.data.routeName&&a.A.current.data.routeName.includes("user.posts")&&a.A.current.data.user,s=a.A.current.data.routeName&&"posts"===a.A.current.data.routeName;return e||t||s?"posts":null}defaultFilters(){const e={};return this.sources.forEach((t=>{e[t.resource]={}})),a.A.current.data.routeName&&["discussion","discussion.near"].includes(a.A.current.data.routeName)&&a.A.current.data.discussion&&(e.posts.discussion=a.A.current.data.discussion.id()),a.A.current.data.routeName&&a.A.current.data.routeName.includes("user.posts")&&a.A.current.data.user&&(e.posts.author=a.A.current.data.user.username()),e}prefill(e){const t=a.A.search.gambits.from(this.activeSource().resource,e,this.defaultFilters()[this.activeSource().resource]||{});return e.includes(t.replace(e,"").trim())?e:t}}(0,r.A)(A,"LIMIT",6),flarum.reg.add("core","common/components/SearchModal",A)}}]);
//# sourceMappingURL=SearchModal.js.map