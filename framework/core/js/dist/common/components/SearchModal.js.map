{"version":3,"file":"common/components/SearchModal.js","mappings":"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","sources":["webpack://@flarum/core/./src/common/components/SearchModal.tsx"],"sourcesContent":["import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport app from '../app';\nimport FormModal from './FormModal';\nimport KeyboardNavigatable from '../utils/KeyboardNavigatable';\nimport SearchManager from '../SearchManager';\nimport extractText from '../utils/extractText';\nimport Input from './Input';\nimport Button from './Button';\nimport Stream from '../utils/Stream';\nimport InfoTile from './InfoTile';\nimport LoadingIndicator from './LoadingIndicator';\nimport ItemList from '../utils/ItemList';\nimport GambitsAutocomplete from '../utils/GambitsAutocomplete';\nexport default class SearchModal extends FormModal {\n  constructor() {\n    super(...arguments);\n    _defineProperty(this, \"searchState\", void 0);\n    _defineProperty(this, \"query\", void 0);\n    /**\n     * An array of SearchSources.\n     */\n    _defineProperty(this, \"sources\", void 0);\n    /**\n     * The key of the currently-active search source.\n     */\n    _defineProperty(this, \"activeSource\", void 0);\n    /**\n     * The sources that are still loading results.\n     */\n    _defineProperty(this, \"loadingSources\", []);\n    /**\n     * The index of the currently-selected <li> in the results list. This can be\n     * a unique string (to account for the fact that an item's position may jump\n     * around as new results load), but otherwise it will be numeric (the\n     * sequential position within the list).\n     */\n    _defineProperty(this, \"index\", 0);\n    _defineProperty(this, \"navigator\", void 0);\n    _defineProperty(this, \"searchTimeout\", void 0);\n    _defineProperty(this, \"inputScroll\", Stream(0));\n    _defineProperty(this, \"gambitsAutocomplete\", {});\n  }\n  oninit(vnode) {\n    super.oninit(vnode);\n    this.searchState = this.attrs.searchState;\n    this.sources = this.attrs.sources;\n    this.activeSource = Stream(this.defaultActiveSource() ? this.sources.find(source => source.resource === this.defaultActiveSource()) || this.sources[0] : this.sources[0]);\n    this.query = Stream(this.prefill(this.searchState.getValue() || '').trim());\n  }\n  title() {\n    return app.translator.trans('core.lib.search.title');\n  }\n  className() {\n    return 'SearchModal Modal--flat';\n  }\n  content() {\n    var _this$gambitsAutocomp, _this$activeSource$re;\n    (_this$gambitsAutocomp = this.gambitsAutocomplete)[_this$activeSource$re = this.activeSource().resource] || (_this$gambitsAutocomp[_this$activeSource$re] = new GambitsAutocomplete(this.activeSource().resource, () => this.inputElement(), this.query, value => this.search(value)));\n    const searchLabel = extractText(app.translator.trans('core.lib.search.placeholder'));\n    return m(\"div\", {\n      className: \"Modal-body SearchModal-body\"\n    }, m(\"div\", {\n      className: \"SearchModal-form\"\n    }, m(Input, {\n      key: \"search\",\n      type: \"search\",\n      loading: !!this.loadingSources.length,\n      clearable: true,\n      clearLabel: app.translator.trans('core.lib.header.search_clear_button_accessible_label'),\n      prefixIcon: \"fas fa-search\",\n      \"aria-label\": searchLabel,\n      placeholder: searchLabel,\n      value: this.query(),\n      onchange: value => {\n        var _this$inputElement$0$, _this$inputElement$;\n        this.query(value);\n        this.inputScroll((_this$inputElement$0$ = (_this$inputElement$ = this.inputElement()[0]) == null ? void 0 : _this$inputElement$.scrollLeft) != null ? _this$inputElement$0$ : 0);\n      },\n      inputAttrs: {\n        className: 'SearchModal-input'\n      },\n      renderInput: attrs => m('[', null, m(\"input\", Object.assign({}, attrs, {\n        onscroll: e => this.inputScroll(e.target.scrollLeft)\n      })), m(\"div\", {\n        className: \"SearchModal-visual-wrapper\"\n      }, m(\"div\", {\n        className: \"SearchModal-visual-input\",\n        style: {\n          left: '-' + this.inputScroll() + 'px'\n        }\n      }, this.gambifyInput())))\n    })), this.tabs());\n  }\n  tabs() {\n    return m(\"div\", {\n      className: \"SearchModal-tabs\"\n    }, m(\"div\", {\n      className: \"SearchModal-tabs-nav\"\n    }, this.tabItems().toArray()), m(\"div\", {\n      className: \"SearchModal-tabs-content\"\n    }, this.activeTabItems().toArray()));\n  }\n  tabItems() {\n    var _this$sources;\n    const items = new ItemList();\n    (_this$sources = this.sources) == null ? void 0 : _this$sources.map((source, index) => items.add(source.resource, m(Button, {\n      className: \"Button Button--link\",\n      active: this.activeSource() === source,\n      onclick: () => this.switchSource(source)\n    }, source.title()), 100 - index));\n    return items;\n  }\n  activeTabItems() {\n    var _this$activeSource;\n    const items = new ItemList();\n    const loading = this.loadingSources.includes(this.activeSource().resource);\n    const shouldShowResults = !!this.query() && !loading;\n    const gambits = this.gambits();\n    const fullPageLink = this.activeSource().fullPage(this.query());\n    const results = (_this$activeSource = this.activeSource()) == null ? void 0 : _this$activeSource.view(this.query());\n    const customGrouping = this.activeSource().customGrouping();\n    if (shouldShowResults && fullPageLink) {\n      items.add('fullPageLink', m(\"div\", {\n        className: \"SearchModal-section\"\n      }, m(\"hr\", {\n        className: \"Modal-divider\"\n      }), m(\"ul\", {\n        className: \"Dropdown-menu SearchModal-fullPage\"\n      }, fullPageLink)), 80);\n    }\n    if (!!gambits.length) {\n      items.add('gambits', m(\"div\", {\n        className: \"SearchModal-section\"\n      }, m(\"hr\", {\n        className: \"Modal-divider\"\n      }), m(\"ul\", {\n        className: \"Dropdown-menu SearchModal-options\",\n        \"aria-live\": gambits.length ? 'polite' : undefined\n      }, m(\"li\", {\n        className: \"Dropdown-header\"\n      }, app.translator.trans('core.lib.search.options_heading')), gambits)), 60);\n    }\n    items.add('results', m(\"div\", {\n      className: \"SearchModal-section\"\n    }, m(\"hr\", {\n      className: \"Modal-divider\"\n    }), m(\"ul\", {\n      className: \"Dropdown-menu SearchModal-results\",\n      \"aria-live\": shouldShowResults ? 'polite' : undefined\n    }, !customGrouping && m(\"li\", {\n      className: \"Dropdown-header\"\n    }, app.translator.trans('core.lib.search.preview_heading')), !shouldShowResults && m(\"li\", {\n      className: \"Dropdown-message\"\n    }, m(InfoTile, {\n      icon: \"fas fa-search\"\n    }, app.translator.trans('core.lib.search.no_search_text'))), shouldShowResults && results, shouldShowResults && !(results != null && results.length) && m(\"li\", {\n      className: \"Dropdown-message\"\n    }, m(InfoTile, {\n      icon: \"far fa-tired\"\n    }, app.translator.trans('core.lib.search.no_results_text'))), loading && m(\"li\", {\n      className: \"Dropdown-message\"\n    }, m(LoadingIndicator, null)))), 40);\n    return items;\n  }\n  switchSource(source) {\n    if (this.activeSource() !== source) {\n      this.activeSource(source);\n      this.search(this.query());\n      this.inputElement().focus();\n      m.redraw();\n    }\n  }\n  gambits() {\n    return this.gambitsAutocomplete[this.activeSource().resource].suggestions(this.query());\n  }\n\n  /**\n   * Transforms a simple search text to wrap valid gambits in a mark tag.\n   * @example `lorem ipsum is:unread dolor` => `lorem ipsum <mark>is:unread</mark> dolor`\n   */\n  gambifyInput() {\n    const query = this.query();\n    let marked = query;\n    app.search.gambits.match(this.activeSource().resource, query, (gambit, matches, negate, bit) => {\n      marked = marked.replace(bit, \"<mark>\".concat(bit, \"</mark>\"));\n    });\n    const jsx = [];\n    marked.split(/(<mark>.*?<\\/mark>)/).forEach(chunk => {\n      if (chunk.startsWith('<mark>')) {\n        jsx.push(m(\"mark\", null, chunk.replace(/<\\/?mark>/g, '')));\n      } else {\n        jsx.push(chunk);\n      }\n    });\n    return jsx;\n  }\n  onupdate(vnode) {\n    var _this$sources2;\n    super.onupdate(vnode);\n\n    // Highlight the item that is currently selected.\n    this.setIndex(this.getCurrentNumericIndex());\n    const component = this;\n    this.$('.Dropdown-menu')\n    // Whenever the mouse is hovered over a search result, highlight it.\n    .on('mouseenter', '> li:not(.Dropdown-header):not(.Dropdown-message)', function () {\n      component.setIndex(component.selectableItems().index(this));\n    });\n\n    // If there are no sources, the search view is not shown.\n    if (!((_this$sources2 = this.sources) != null && _this$sources2.length)) return;\n  }\n  oncreate(vnode) {\n    var _this$sources3;\n    super.oncreate(vnode);\n\n    // If there are no sources, we shouldn't initialize logic for\n    // search elements, as they will not be shown.\n    if (!((_this$sources3 = this.sources) != null && _this$sources3.length)) return;\n    const search = this.search.bind(this);\n\n    // Highlight the item that is currently selected.\n    this.setIndex(this.getCurrentNumericIndex());\n    const $input = this.inputElement();\n    this.navigator = new KeyboardNavigatable();\n    this.navigator.onUp(() => this.setIndex(this.getCurrentNumericIndex() - 1, true)).onDown(() => this.setIndex(this.getCurrentNumericIndex() + 1, true)).onSelect(this.selectResult.bind(this), true).onCancel(this.clear.bind(this)).bindTo($input);\n\n    // Handle input key events on the search input, triggering results to load.\n    $input.on('input focus', function () {\n      search(this.value.toLowerCase());\n    });\n  }\n  onremove(vnode) {\n    this.searchState.setValue(this.query());\n    super.onremove(vnode);\n  }\n  search(query) {\n    if (!query) return;\n    const source = this.activeSource();\n    if (this.searchTimeout) clearTimeout(this.searchTimeout);\n    this.searchTimeout = window.setTimeout(() => {\n      if (source.isCached(query)) return;\n      if (query.length >= SearchManager.MIN_SEARCH_LEN) {\n        if (!source.search) return;\n        this.loadingSources.push(source.resource);\n        source.search(query, SearchModal.LIMIT).then(() => {\n          this.loadingSources = this.loadingSources.filter(resource => resource !== source.resource);\n          m.redraw();\n        });\n      }\n      this.searchState.cache(query);\n      m.redraw();\n    }, 250);\n  }\n\n  /**\n   * Navigate to the currently selected search result and close the list.\n   */\n  selectResult() {\n    if (this.searchTimeout) clearTimeout(this.searchTimeout);\n    this.loadingSources = [];\n    const item = this.getItem(this.index);\n    const isResult = !!item.attr('data-id');\n    let selectedUrl = null;\n    if (isResult) {\n      const id = item.attr('data-id');\n      selectedUrl = id && this.activeSource().gotoItem(id);\n    } else if (item.find('a').length) {\n      selectedUrl = item.find('a').attr('href');\n    }\n    const query = this.query();\n    if (query && selectedUrl) {\n      m.route.set(selectedUrl);\n    } else {\n      item.find('button')[0].click();\n    }\n  }\n\n  /**\n   * Clear the search\n   */\n  clear() {\n    this.query('');\n  }\n\n  /**\n   * Get all of the search result items that are selectable.\n   */\n  selectableItems() {\n    return this.$('.Dropdown-menu > li:not(.Dropdown-header):not(.Dropdown-message)');\n  }\n\n  /**\n   * Get the position of the currently selected search result item.\n   * Returns zero if not found.\n   */\n  getCurrentNumericIndex() {\n    return Math.max(0, this.selectableItems().index(this.getItem(this.index)));\n  }\n\n  /**\n   * Get the <li> in the search results with the given index (numeric or named).\n   */\n  getItem(index) {\n    const $items = this.selectableItems();\n    let $item = $items.filter(\"[data-index=\\\"\".concat(index, \"\\\"]\"));\n    if (!$item.length) {\n      $item = $items.eq(index);\n    }\n    return $item;\n  }\n\n  /**\n   * Set the currently-selected search result item to the one with the given\n   * index.\n   */\n  setIndex(index, scrollToItem) {\n    if (scrollToItem === void 0) {\n      scrollToItem = false;\n    }\n    const $items = this.selectableItems();\n    const $dropdown = $items.parent();\n    let fixedIndex = index;\n    if (index < 0) {\n      fixedIndex = $items.length - 1;\n    } else if (index >= $items.length) {\n      fixedIndex = 0;\n    }\n    const $item = $items.removeClass('active').eq(fixedIndex).addClass('active');\n    this.index = parseInt($item.attr('data-index')) || fixedIndex;\n    if (scrollToItem && $dropdown) {\n      const dropdownScroll = $dropdown.scrollTop();\n      const dropdownTop = $dropdown.offset().top;\n      const dropdownBottom = dropdownTop + $dropdown.outerHeight();\n      const itemTop = $item.offset().top;\n      const itemBottom = itemTop + $item.outerHeight();\n      let scrollTop;\n      if (itemTop < dropdownTop) {\n        scrollTop = dropdownScroll - dropdownTop + itemTop - parseInt($dropdown.css('padding-top'), 10);\n      } else if (itemBottom > dropdownBottom) {\n        scrollTop = dropdownScroll - dropdownBottom + itemBottom + parseInt($dropdown.css('padding-bottom'), 10);\n      }\n      if (typeof scrollTop !== 'undefined') {\n        $dropdown.stop(true).animate({\n          scrollTop\n        }, 100);\n      }\n    }\n  }\n  inputElement() {\n    return this.$('.SearchModal-input');\n  }\n  defaultActiveSource() {\n    const inDiscussion = app.current.data.routeName && ['discussion', 'discussion.near'].includes(app.current.data.routeName) && app.current.data.discussion;\n    const inUser = app.current.data.routeName && app.current.data.routeName.includes('user.posts') && app.current.data.user;\n    const inPosts = app.current.data.routeName && app.current.data.routeName === 'posts';\n    if (inDiscussion || inUser || inPosts) {\n      return 'posts';\n    }\n    return null;\n  }\n  defaultFilters() {\n    const filters = {};\n    this.sources.forEach(source => {\n      filters[source.resource] = {};\n    });\n    if (app.current.data.routeName && ['discussion', 'discussion.near'].includes(app.current.data.routeName) && app.current.data.discussion) {\n      filters.posts.discussion = app.current.data.discussion.id();\n    }\n    if (app.current.data.routeName && app.current.data.routeName.includes('user.posts') && app.current.data.user) {\n      filters.posts.author = app.current.data.user.username();\n    }\n    return filters;\n  }\n  prefill(value) {\n    const newQuery = app.search.gambits.from(this.activeSource().resource, value, this.defaultFilters()[this.activeSource().resource] || {});\n    if (!value.includes(newQuery.replace(value, '').trim())) {\n      return newQuery;\n    }\n    return value;\n  }\n}\n_defineProperty(SearchModal, \"LIMIT\", 6);\nflarum.reg.add('core', 'common/components/SearchModal', SearchModal);"],"names":["SearchModal","constructor","super","arguments","this","oninit","vnode","searchState","attrs","sources","activeSource","defaultActiveSource","find","source","resource","query","prefill","getValue","trim","title","className","content","_this$gambitsAutocomp","_this$activeSource$re","gambitsAutocomplete","inputElement","value","search","searchLabel","m","key","type","loading","loadingSources","length","clearable","clearLabel","prefixIcon","placeholder","onchange","_this$inputElement$0$","_this$inputElement$","inputScroll","scrollLeft","inputAttrs","renderInput","Object","assign","onscroll","e","target","style","left","gambifyInput","tabs","tabItems","toArray","activeTabItems","_this$sources","items","map","index","add","active","onclick","switchSource","_this$activeSource","includes","shouldShowResults","gambits","fullPageLink","fullPage","results","view","customGrouping","undefined","icon","focus","redraw","suggestions","marked","gambit","matches","negate","bit","replace","concat","jsx","split","forEach","chunk","startsWith","push","onupdate","_this$sources2","setIndex","getCurrentNumericIndex","component","$","on","selectableItems","oncreate","_this$sources3","bind","$input","navigator","onUp","onDown","onSelect","selectResult","onCancel","clear","bindTo","toLowerCase","onremove","setValue","searchTimeout","clearTimeout","window","setTimeout","isCached","LIMIT","then","filter","cache","item","getItem","selectedUrl","attr","id","gotoItem","route","set","click","Math","max","$items","$item","eq","scrollToItem","$dropdown","parent","fixedIndex","removeClass","addClass","parseInt","dropdownScroll","scrollTop","dropdownTop","offset","top","dropdownBottom","outerHeight","itemTop","itemBottom","css","stop","animate","inDiscussion","inUser","inPosts","defaultFilters","filters","posts","discussion","author","newQuery","flarum","reg"],"sourceRoot":""}