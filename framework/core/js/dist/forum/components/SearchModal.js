"use strict";(self.webpackChunkflarum_core=self.webpackChunkflarum_core||[]).push([[616],{7502:(e,t,s)=>{s.r(t),s.d(t,{default:()=>f});var a=s(7905),r=s(6789),i=s(899),o=s(8046),c=s(8740),n=s(1552),l=s(9908),h=s(8312),u=s(6458),d=s(3986),p=s(5226),v=s(4041),g=s(4945);class f extends i.Z{constructor(){super(...arguments),(0,a.Z)(this,"searchState",void 0),(0,a.Z)(this,"query",void 0),(0,a.Z)(this,"sources",void 0),(0,a.Z)(this,"activeSource",void 0),(0,a.Z)(this,"loadingSources",[]),(0,a.Z)(this,"index",0),(0,a.Z)(this,"navigator",void 0),(0,a.Z)(this,"searchTimeout",void 0),(0,a.Z)(this,"inputScroll",(0,u.Z)(0)),(0,a.Z)(this,"gambitsAutocomplete",{})}oninit(e){super.oninit(e),this.searchState=this.attrs.searchState,this.sources=this.attrs.sources,this.query=(0,u.Z)(this.searchState.getValue()||"")}title(){return r.Z.translator.trans("core.forum.search.title")}className(){return"SearchModal Modal--flat"}content(){var e,t;this.activeSource||(this.activeSource=(0,u.Z)(this.sources[0])),(e=this.gambitsAutocomplete)[t=this.activeSource().resource]||(e[t]=new g.Z(this.activeSource().resource,(()=>this.inputElement()),this.query,(e=>this.search(e))));const s=(0,n.Z)(r.Z.translator.trans("core.forum.search.placeholder"));return m("div",{className:"Modal-body SearchModal-body"},m("div",{className:"SearchModal-form"},m(l.Z,{key:"search",type:"search",loading:!!this.loadingSources.length,clearable:!0,clearLabel:r.Z.translator.trans("core.forum.header.search_clear_button_accessible_label"),prefixIcon:"fas fa-search","aria-label":s,placeholder:s,value:this.query(),onchange:e=>{var t,s;this.query(e),this.inputScroll(null!=(t=null==(s=this.inputElement()[0])?void 0:s.scrollLeft)?t:0)},inputAttrs:{className:"SearchModal-input"},renderInput:e=>m("[",null,m("input",Object.assign({},e,{onscroll:e=>this.inputScroll(e.target.scrollLeft)})),m("div",{className:"SearchModal-visual-wrapper"},m("div",{className:"SearchModal-visual-input",style:{left:"-"+this.inputScroll()+"px"}},this.gambifyInput())))})),this.tabs())}tabs(){return m("div",{className:"SearchModal-tabs"},m("div",{className:"SearchModal-tabs-nav"},this.tabItems().toArray()),m("div",{className:"SearchModal-tabs-content"},this.activeTabItems().toArray()))}tabItems(){var e;const t=new v.Z;return null==(e=this.sources)||e.map(((e,s)=>t.add(e.resource,m(h.Z,{className:"Button Button--link",active:this.activeSource()===e,onclick:()=>this.switchSource(e)},e.title()),100-s))),t}activeTabItems(){var e;const t=new v.Z,s=this.loadingSources.includes(this.activeSource().resource),a=!!this.query()&&!s,i=this.gambits(),o=this.activeSource().fullPage(this.query()),c=null==(e=this.activeSource())?void 0:e.view(this.query());return a&&o&&t.add("fullPageLink",m("div",{className:"SearchModal-section"},m("hr",{className:"Modal-divider"}),m("ul",{className:"Dropdown-menu SearchModal-fullPage"},o)),80),i.length&&t.add("gambits",m("div",{className:"SearchModal-section"},m("hr",{className:"Modal-divider"}),m("ul",{className:"Dropdown-menu SearchModal-options","aria-live":i.length?"polite":void 0},m("li",{className:"Dropdown-header"},r.Z.translator.trans("core.forum.search.options_heading")),i)),60),t.add("results",m("div",{className:"SearchModal-section"},m("hr",{className:"Modal-divider"}),m("ul",{className:"Dropdown-menu SearchModal-results","aria-live":a?"polite":void 0},m("li",{className:"Dropdown-header"},r.Z.translator.trans("core.forum.search.preview_heading")),!a&&m("li",{className:"Dropdown-message"},m(d.Z,{icon:"fas fa-search"},r.Z.translator.trans("core.forum.search.no_search_text"))),a&&c,a&&!(null!=c&&c.length)&&m("li",{className:"Dropdown-message"},m(d.Z,{icon:"far fa-tired"},r.Z.translator.trans("core.forum.search.no_results_text"))),s&&m("li",{className:"Dropdown-message"},m(p.Z,null)))),40),t}switchSource(e){this.activeSource()!==e&&(this.activeSource(e),this.search(this.query()),this.inputElement().focus(),m.redraw())}gambits(){return this.gambitsAutocomplete[this.activeSource().resource].suggestions(this.query())}gambifyInput(){const e=this.query();let t=e;r.Z.search.gambits.match(this.activeSource().resource,e,((e,s,a,r)=>{t=t.replace(r,"<mark>".concat(r,"</mark>"))}));const s=[];return t.split(/(<mark>.*?<\/mark>)/).forEach((e=>{e.startsWith("<mark>")?s.push(m("mark",null,e.replace(/<\/?mark>/g,""))):s.push(e)})),s}onupdate(e){var t;super.onupdate(e),this.setIndex(this.getCurrentNumericIndex());const s=this;this.$(".Dropdown-menu").on("mouseenter","> li:not(.Dropdown-header):not(.Dropdown-message)",(function(){s.setIndex(s.selectableItems().index(this))})),null!=(t=this.sources)&&t.length}oncreate(e){var t;if(super.oncreate(e),null==(t=this.sources)||!t.length)return;const s=this.search.bind(this);this.setIndex(this.getCurrentNumericIndex());const a=this.inputElement();this.navigator=new o.Z,this.navigator.onUp((()=>this.setIndex(this.getCurrentNumericIndex()-1,!0))).onDown((()=>this.setIndex(this.getCurrentNumericIndex()+1,!0))).onSelect(this.selectResult.bind(this),!0).onCancel(this.clear.bind(this)).bindTo(a),a.on("input focus",(function(){s(this.value.toLowerCase())}))}onremove(e){this.searchState.setValue(this.query()),super.onremove(e)}search(e){if(!e)return;const t=this.activeSource();this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=window.setTimeout((()=>{if(!t.isCached(e)){if(e.length>=c.Z.MIN_SEARCH_LEN){if(!t.search)return;this.loadingSources.push(t.resource),t.search(e,f.LIMIT).then((()=>{this.loadingSources=this.loadingSources.filter((e=>e!==t.resource)),m.redraw()}))}this.searchState.cache(e),m.redraw()}}),250)}selectResult(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.loadingSources=[];const e=this.getItem(this.index);let t=null;if(e.attr("data-id")){const s=e.attr("data-id");t=s&&this.activeSource().gotoItem(s)}else e.find("a").length&&(t=e.find("a").attr("href"));this.query()&&t?m.route.set(t):e.find("button")[0].click()}clear(){this.query("")}selectableItems(){return this.$(".Dropdown-menu > li:not(.Dropdown-header):not(.Dropdown-message)")}getCurrentNumericIndex(){return Math.max(0,this.selectableItems().index(this.getItem(this.index)))}getItem(e){const t=this.selectableItems();let s=t.filter('[data-index="'.concat(e,'"]'));return s.length||(s=t.eq(e)),s}setIndex(e,t){void 0===t&&(t=!1);const s=this.selectableItems(),a=s.parent();let r=e;e<0?r=s.length-1:e>=s.length&&(r=0);const i=s.removeClass("active").eq(r).addClass("active");if(this.index=parseInt(i.attr("data-index"))||r,t&&a){const e=a.scrollTop(),t=a.offset().top,s=t+a.outerHeight(),r=i.offset().top,o=r+i.outerHeight();let c;r<t?c=e-t+r-parseInt(a.css("padding-top"),10):o>s&&(c=e-s+o+parseInt(a.css("padding-bottom"),10)),void 0!==c&&a.stop(!0).animate({scrollTop:c},100)}}inputElement(){return this.$(".SearchModal-input")}}(0,a.Z)(f,"LIMIT",6),flarum.reg.add("core","forum/components/SearchModal",f)}}]);
//# sourceMappingURL=SearchModal.js.map