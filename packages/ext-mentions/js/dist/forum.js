module.exports=function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=38)}([function(t,e){t.exports=flarum.core.compat["common/extend"]},function(t,e){t.exports=flarum.core.compat.app},function(t,e){t.exports=flarum.core.compat.extend},function(t,e){t.exports=flarum.core.compat["utils/string"]},function(t,e){t.exports=flarum.core.compat["forum/components/CommentPost"]},function(t,e){t.exports=flarum.core.compat["forum/components/PostPreview"]},function(t,e){t.exports=flarum.core.compat["common/helpers/username"]},function(t,e){t.exports=flarum.core.compat["components/CommentPost"]},function(t,e){t.exports=flarum.core.compat["forum/components/EditPostComposer"]},function(t,e){t.exports=flarum.core.compat.Fragment},function(t,e){t.exports=flarum.core.compat["components/Notification"]},function(t,e){t.exports=flarum.core.compat["common/components/TextEditor"]},function(t,e){t.exports=flarum.core.compat["helpers/username"]},function(t,e){t.exports=flarum.core.compat["utils/extractText"]},,function(t,e){t.exports=flarum.core.compat["components/NotificationGrid"]},function(t,e){t.exports=flarum.core.compat["common/components/LoadingIndicator"]},function(t,e){t.exports=flarum.core.compat["common/Model"]},function(t,e){t.exports=flarum.core.compat["common/models/Post"]},function(t,e){t.exports=flarum.core.compat["common/components/Link"]},function(t,e){t.exports=flarum.core.compat["common/helpers/punctuateSeries"]},function(t,e){t.exports=flarum.core.compat["common/helpers/icon"]},function(t,e){t.exports=flarum.core.compat["components/Button"]},function(t,e){t.exports=flarum.core.compat["forum/utils/DiscussionControls"]},function(t,e){t.exports=flarum.core.compat["common/utils/extractText"]},function(t,e){t.exports=flarum.core.compat["helpers/icon"]},function(t,e){t.exports=flarum.core.compat["common/components/TextEditorButton"]},function(t,e){t.exports=flarum.core.compat["forum/components/ReplyComposer"]},function(t,e){t.exports=flarum.core.compat["common/helpers/avatar"]},function(t,e){t.exports=flarum.core.compat["common/helpers/highlight"]},function(t,e){t.exports=flarum.core.compat["forum/utils/KeyboardNavigatable"]},function(t,e){t.exports=flarum.core.compat["common/utils/string"]},function(t,e){t.exports=flarum.core.compat["common/utils/throttleDebounce"]},function(t,e){t.exports=flarum.core.compat["components/UserPage"]},function(t,e){t.exports=flarum.core.compat["components/LinkButton"]},function(t,e){t.exports=flarum.core.compat["components/PostsUserPage"]},function(t,e){t.exports=flarum.core},,function(t,e,n){"use strict";n.r(e),n.d(e,"filterUserMentions",(function(){return kt})),n.d(e,"filterPostMentions",(function(){return Nt}));var o={};n.r(o),n.d(o,"insertMention",(function(){return F})),n.d(o,"default",(function(){return z}));var r={};n.r(r),n.d(r,"filterUserMentions",(function(){return kt})),n.d(r,"filterPostMentions",(function(){return Nt}));var s=n(2),i=n(1),a=n.n(i),u=n(15),c=n.n(u),f=n(3),p=n(0),l=n(4),d=n.n(l),h=n(5),v=n.n(h),b=n(16),g=n.n(b);var y=n(17),x=n.n(y),w=n(18),P=n.n(w),C=n(19),M=n.n(C),T=n(20),_=n.n(T),j=n(6),O=n.n(j),B=n(21),A=n.n(B);var k=n(22),N=n.n(k),S=n(7),H=n.n(S),D=n(23),I=n.n(D),U=n(8),E=n.n(U),W=n(24),L=n.n(W),R=function(){return L()(app.translator.trans("core.lib.username.deleted_text"))};function q(t,e){return void 0===e&&(e=!0),t?((e?t.displayName():t.username())||R()).replace(/"#[a-z]{0,3}[0-9]+/,"_"):R().replace(/"#[a-z]{0,3}[0-9]+/,"_")}function J(t,e){return void 0===e?app.forum.attribute("allowUsernameMentionFormat")?"@"+q(t,!1):'@"'+q(t)+'"#'+t.id():'@"'+q(t)+'"#p'+e}function F(t,e,n){return new Promise((function(o){var r=J(t.user(),t.id())+" ";e.fields.content()||(e.body.attrs.originalContent=r);var s=e.editor.getSelectionRange()[0],i=e.fields.content().slice(0,s),a=0==i.length?0:3-i.match(/(\n{0,2})$/)[0].length;return e.editor.insertAtCursor(Array(a).join("\n")+(n?"> "+r+n.trim().replace(/\n/g,"\n> ")+"\n\n":r),!1),o(e)}))}function z(t,e){return app.composer.bodyMatches(E.a)&&app.composer.body.attrs.post.discussion()===t.discussion()?F(t,app.composer,e):I.a.replyAction.call(t.discussion()).then((function(n){return F(t,n,e)}))}function Q(t,e){return(Q=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function X(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Q(t,e)}var Y=n(9),G=n.n(Y),K=n(25),V=n.n(K),Z=function(t){function e(e){var n;return(n=t.call(this)||this).post=e,n}X(e,t);var n=e.prototype;return n.view=function(){var t=this;return m("button",{class:"Button PostQuoteButton",onclick:function(){z(t.post,t.content)}},V()("fas fa-quote-left",{className:"Button-icon"}),app.translator.trans("flarum-mentions.forum.post.quote_button"))},n.show=function(t,e){var n=this.$().show(),o=n.offsetParent().offset();n.css("left",t-o.left).css("top",e-o.top),this.hideHandler=this.hide.bind(this),$(document).on("mouseup",this.hideHandler)},n.showStart=function(t,e){var n=this.$();this.show(t,$(window).scrollTop()+e-n.outerHeight()-5)},n.showEnd=function(t,e){var n=this.$();this.show(t-n.outerWidth(),$(window).scrollTop()+e+5)},n.hide=function(){this.$().hide(),$(document).off("mouseup",this.hideHandler)},e}(G.a);function tt(t){var e=window.getSelection();if(null!=e&&e.rangeCount){var n=e.getRangeAt(0),o=n.commonAncestorContainer;if(t[0]===o||$.contains(t[0],o)){var r=$("<div>").append(n.cloneContents());return r.find("img.emoji").replaceWith((function(){return this.alt})),r.find("img").replaceWith((function(){return"![]("+this.src+")"})),r.find("a").replaceWith((function(){return"["+this.innerText+"]("+this.href+")"})),r.text()}}return""}var et=n(11),nt=n.n(et),ot=n(26),rt=n.n(ot),st=n(27),it=n.n(st),at=n(28),ut=n.n(at),ct=n(29),ft=n.n(ct),pt=n(30),mt=n.n(pt),lt=n(31),dt=n(32),ht=function(t){function e(){for(var e,n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(e=t.call.apply(t,[this].concat(o))||this).items=[],e.active=!1,e.index=0,e.keyWasJustPressed=!1,e}X(e,t);var n=e.prototype;return n.view=function(){return m("ul",{className:"Dropdown-menu MentionsDropdown"},this.items.map((function(t){return m("li",null,t)})))},n.show=function(t,e){this.$().show().css({left:t+"px",top:e+"px"}),this.active=!0},n.hide=function(){this.$().hide(),this.active=!1},n.navigate=function(t){var e=this;this.keyWasJustPressed=!0,this.setIndex(this.index+t,!0),clearTimeout(this.keyWasJustPressedTimeout),this.keyWasJustPressedTimeout=setTimeout((function(){return e.keyWasJustPressed=!1}),500)},n.complete=function(){this.$("li").eq(this.index).find("button").click()},n.setIndex=function(t,e){if(!this.keyWasJustPressed||e){var n=this.$(),o=n.find("li"),r=t;r<0?r=o.length-1:r>=o.length&&(r=0),this.index=r;var s=o.removeClass("active").eq(r).addClass("active");if(e){var i,a=n.scrollTop(),u=n.offset().top,c=u+n.outerHeight(),f=s.offset().top,p=f+s.outerHeight();f<u?i=a-u+f-parseInt(n.css("padding-top"),10):p>c&&(i=a-c+p+parseInt(n.css("padding-bottom"),10)),void 0!==i&&n.stop(!0).animate({scrollTop:i},100)}}},e}(G.a),vt=Object(dt.throttle)(250,(function(t,e,n,o,r,s){var i=t.toLowerCase();e.includes(i)||(app.store.find("users",{filter:{q:t},page:{limit:5}}).then((function(t){t.forEach((function(t){o.has(t.id())||(o.add(t.id()),n.push(t))})),s()})),e.push(i))}));function bt(){var t=$('<div class="ComposerBody-mentionsDropdownContainer"></div>'),e=new ht;Object(p.extend)(nt.a.prototype,"oncreate",(function(){var n=this.$(".TextEditor-editor").wrap('<div class="ComposerBody-mentionsWrapper"></div>');this.navigator=new mt.a,this.navigator.when((function(){return e.active})).onUp((function(){return e.navigate(-1)})).onDown((function(){return e.navigate(1)})).onSelect(e.complete.bind(e)).onCancel(e.hide.bind(e)).bindTo(n),n.after(t)})),Object(p.extend)(nt.a.prototype,"buildEditorParams",(function(n){var o,r,s,i,a=this,u=[],c=Array.from(app.store.all("users")),f=new Set(c.map((function(t){return t.id()})));n.inputListeners.push((function(){var n=a.attrs.composer.editor.getSelectionRange(),p=n[0];if(!(n[1]-p>0)){var l=a.attrs.composer.editor.getLastNChars(30);r=0;for(var d=l.length-1;d>=0;d--){if("@"===l.substr(d,1)&&(0==d||/\s/.test(l.substr(d-1,1)))){o=d+1,r=p-l.length+d+1;break}}if(e.hide(),e.active=!1,r){s=l.substring(o).toLowerCase(),i=s.match(/^["|â€œ]((?:(?!"#).)+)$/),s=i&&i[1]||s;var h=function(t,n,o,i){void 0===i&&(i="");var u=O()(t);return s&&(u.children=[ft()(u.text,s)],delete u.text),m("button",{className:"PostPreview "+i,onclick:function(){return function(t){a.attrs.composer.editor.replaceBeforeCursor(r-1,t+" "),e.hide()}(n)},onmouseenter:function(){e.setIndex($(this).parent().index())}},m("span",{className:"PostPreview-content"},ut()(t),u," ",o))},v=function(t){return[t.username(),t.displayName()].some((function(t){return t.toLowerCase().substr(0,s.length)===s}))},b=function(){var n=[];if(s&&c.forEach((function(t){v(t)&&n.push(h(t,J(t),"","MentionsDropdown-user"))})),a.attrs.composer.bodyMatches(it.a)||a.attrs.composer.bodyMatches(E.a)){var o=a.attrs.composer.body.attrs,i=o.post,u=i&&i.discussion()||o.discussion;u&&u.posts().filter((function(t){return t&&"comment"===t.contentType()&&(!i||t.number()<i.number())})).sort((function(t,e){return e.createdAt()-t.createdAt()})).filter((function(t){var e=t.user();return e&&v(e)})).splice(0,5).forEach((function(t){var e=t.user();n.push(h(e,J(e,t.id()),[app.translator.trans("flarum-mentions.forum.composer.reply_to_post_text",{number:t.number()})," â€” ",Object(lt.truncate)(t.contentPlain(),200)],"MentionsDropdown-post"))}))}if(n.length){e.items=n,m.render(t[0],e.render()),e.show();var f=a.attrs.composer.editor.getCaretCoordinates(r),p=e.$().outerWidth(),l=e.$().outerHeight(),d=e.$().offsetParent(),b=f.left,g=f.top+15;g+l>d.height()&&(g=f.top-l-15),b+p>d.width()&&(b=d.width()-p),g=Math.max(-(d.offset().top-$(document).scrollTop()),g),b=Math.max(-d.offset().left,b),e.show(b,g)}else e.active=!1,e.hide()};e.active=!0,b(),e.setIndex(0),e.$().scrollTop(0),s.length>1&&app.forum.attribute("canSearchUsers")&&vt(s,u,c,f,e,b)}}}))})),Object(p.extend)(nt.a.prototype,"toolbarItems",(function(t){var e=this;t.add("mention",m(rt.a,{onclick:function(){return e.attrs.composer.editor.insertAtCursor(" @")},icon:"fas fa-at"},app.translator.trans("flarum-mentions.forum.composer.mention_tooltip")))}))}var gt=n(10),yt=n.n(gt),xt=function(t){function e(){return t.apply(this,arguments)||this}X(e,t);var n=e.prototype;return n.icon=function(){return"fas fa-reply"},n.href=function(){var t=this.attrs.notification,e=t.subject(),n=t.content();return app.route.discussion(e.discussion(),n&&n.replyNumber)},n.content=function(){var t=this.attrs.notification.fromUser();return app.translator.trans("flarum-mentions.forum.notifications.post_mentioned_text",{user:t,count:1})},n.excerpt=function(){return Object(f.truncate)(this.attrs.notification.subject().contentPlain(),200)},e}(yt.a),wt=function(t){function e(){return t.apply(this,arguments)||this}X(e,t);var n=e.prototype;return n.icon=function(){return"fas fa-at"},n.href=function(){var t=this.attrs.notification.subject();return app.route.discussion(t.discussion(),t.number())},n.content=function(){var t=this.attrs.notification.fromUser();return app.translator.trans("flarum-mentions.forum.notifications.user_mentioned_text",{user:t})},n.excerpt=function(){return Object(f.truncate)(this.attrs.notification.subject().contentPlain(),200)},e}(yt.a),Pt=n(33),$t=n.n(Pt),Ct=n(34),Mt=n.n(Ct),Tt=n(35),_t=function(t){function e(){return t.apply(this,arguments)||this}return X(e,t),e.prototype.loadResults=function(t){return app.store.find("posts",{filter:{type:"comment",mentioned:this.user.id()},page:{offset:t,limit:this.loadLimit},sort:"-createdAt"})},e}(n.n(Tt).a),jt=n(12),Ot=n.n(jt),Bt=n(13),At=n.n(Bt);function kt(t){var e;if(app.forum.attribute("allowUsernameMentionFormat")&&t.hasAttribute("username")?e=app.store.getBy("users","username",t.getAttribute("username")):t.hasAttribute("id")&&(e=app.store.getById("users",t.getAttribute("id"))),e)return t.setAttribute("id",e.id()),t.setAttribute("slug",e.slug()),t.setAttribute("displayname",At()(Ot()(e))),!0;t.invalidate()}function Nt(t){var e=app.store.getById("posts",t.getAttribute("id"));if(e)return t.setAttribute("discussionid",e.discussion().id()),t.setAttribute("number",e.number()),t.setAttribute("displayname",At()(Ot()(e.user()))),!0}var St={"mentions/components/MentionsUserPage":_t,"mentions/components/PostMentionedNotification":xt,"mentions/components/UserMentionedNotification":wt,"mentions/fragments/AutocompleteDropdown":ht,"mentions/fragments/PostQuoteButton":Z,"mentions/utils/getCleanDisplayName":q,"mentions/utils/getMentionText":J,"mentions/utils/reply":o,"mentions/utils/selectedText":tt,"mentions/utils/textFormatter":r},Ht=n(36);a.a.initializers.add("flarum-mentions",(function(){!function(){function t(){var t=this.attrs.post.contentHtml();if(t!==this.oldPostContentHtml&&!this.isEditing()){this.oldPostContentHtml=t;var e=this.attrs.post,n=this.$();this.$().on("click",".UserMention:not(.UserMention--deleted), .PostMention:not(.PostMention--deleted)",(function(t){m.route.set(this.getAttribute("href")),t.preventDefault()})),this.$(".PostMention:not(.PostMention--deleted)").each((function(){var t,o=$(this),r=o.data("id"),s=$('<ul class="Dropdown-menu PostMention-preview fade"/>');n.append(s);var i=function(){return $('.PostStream-item[data-id="'+r+'"]')},a=function(){var t=i(),a=!1;if(t.length){var u=t.offset().top,c=window.pageYOffset;u>c&&u+t.height()<c+$(window).height()&&(t.addClass("pulsate"),a=!0)}if(!a){var f=function(){var t=s.outerHeight(!0),e=0;o.offset().top-t<$(window).scrollTop()+$("#header").outerHeight()?e+=o.outerHeight(!0):e-=t,s.show().css("top",o.offset().top-n.offset().top+e).css("left",o.offsetParent().offset().left-n.offset().left).css("max-width",o.offsetParent().width())},p=function(t){var n=t.discussion();m.render(s[0],[n!==e.discussion()?m("li",null,m("span",{className:"PostMention-preview-discussion"},n.title())):"",m("li",null,v.a.component({post:t}))]),f()},l=app.store.getById("posts",r);l&&l.discussion()?p(l):(m.render(s[0],g.a.component()),app.store.find("posts",r).then(p),f()),setTimeout((function(){return s.off("transitionend").addClass("in")}))}},u=function(){i().removeClass("pulsate"),s.hasClass("in")&&s.removeClass("in").one("transitionend",(function(){return s.hide()}))};o.on("touchend",(function(t){t.cancelable&&t.preventDefault()})),o.add(s).hover((function(){clearTimeout(t),t=setTimeout(a,250)}),(function(){clearTimeout(t),i().removeClass("pulsate"),t=setTimeout(u,250)})).on("touchend",(function(t){a(),t.stopPropagation()})),$(document).on("touchend",u)}))}}Object(p.extend)(d.a.prototype,"oncreate",t),Object(p.extend)(d.a.prototype,"onupdate",t)}(),function(){function t(){this.$(".Post-mentionedBy-preview").removeClass("in").one("transitionend",(function(){$(this).hide()}))}P.a.prototype.mentionedBy=x.a.hasMany("mentionedBy"),Object(p.extend)(d.a.prototype,"oncreate",(function(){var e,n=this,o=this.attrs.post.mentionedBy();if(o&&o.length){var r=$('<ul class="Dropdown-menu Post-mentionedBy-preview fade"/>');this.$().append(r);var s=this.$(),i=this.$(".Post-mentionedBy"),a=function(){!r.hasClass("in")&&r.is(":visible")||(m.render(r[0],o.map((function(e){return m("li",{"data-number":e.number()},v.a.component({post:e,onclick:t.bind(n)}))}))),r.show().css("top",i.offset().top-s.offset().top+i.outerHeight(!0)).css("left",i.offsetParent().offset().left-s.offset().left).css("max-width",s.width()),setTimeout((function(){return r.off("transitionend").addClass("in")})))};i.add(r).hover((function(){clearTimeout(e),e=setTimeout(a,250)}),(function(){clearTimeout(e),e=setTimeout(t,250)})),this.$().find(".Post-mentionedBy-summary a").hover((function(){r.find('[data-number="'+$(this).data("number")+'"]').addClass("active")}),(function(){r.find("[data-number]").removeClass("active")}))}})),Object(p.extend)(d.a.prototype,"footerItems",(function(e){var n=this,o=this.attrs.post.mentionedBy();if(o&&o.length){var r=[],s=o.sort((function(t){return t.user()===app.session.user?-1:0})).filter((function(t){var e=t.user();if(-1===r.indexOf(e))return r.push(e),!0})),i=s.length>4,a=s.slice(0,i?3:4).map((function(e){var o=e.user();return m(M.a,{href:app.route.post(e),onclick:t.bind(n),"data-number":e.number()},app.session.user===o?app.translator.trans("flarum-mentions.forum.post.you_text"):O()(o))}));if(i){var u=s.length-a.length;a.push(app.translator.trans("flarum-mentions.forum.post.others_text",{count:u}))}e.add("replies",m("div",{className:"Post-mentionedBy"},m("span",{className:"Post-mentionedBy-summary"},A()("fas fa-reply"),app.translator.trans("flarum-mentions.forum.post.mentioned_by"+(s[0].user()===app.session.user?"_self":"")+"_text",{count:a.length,users:_()(a)}))))}}))}(),Object(s.extend)(H.a.prototype,"actionItems",(function(t){var e=this.attrs.post;e.isHidden()||app.session.user&&!e.discussion().canReply()||t.add("reply",m(N.a,{className:"Button Button--link",onclick:function(){return z(e)}},app.translator.trans("flarum-mentions.forum.post.reply_link")))})),Object(s.extend)(H.a.prototype,"oncreate",(function(){var t=this.attrs.post;if(!(t.isHidden()||app.session.user&&!t.discussion().canReply())){var e=this.$(".Post-body"),n=$('<div class="Post-quoteButtonContainer"></div>'),o=new Z(t),r=function(t){setTimeout((function(){var r=tt(e);if(r){o.content=r,m.render(n[0],o.render());var s=window.getSelection().getRangeAt(0).getClientRects(),i=s[0];if(t.clientY<i.bottom&&t.clientX-i.right<i.left-t.clientX)o.showStart(i.left,i.top);else{var a=s[s.length-1];o.showEnd(a.right,a.bottom)}}}),1)};this.$().after(n).on("mouseup",r),"ontouchstart"in window&&document.addEventListener("selectionchange",r,!1)}})),bt(),a.a.notificationComponents.postMentioned=xt,a.a.notificationComponents.userMentioned=wt,Object(s.extend)(c.a.prototype,"notificationTypes",(function(t){t.add("postMentioned",{name:"postMentioned",icon:"fas fa-reply",label:a.a.translator.trans("flarum-mentions.forum.settings.notify_post_mentioned_label")}),t.add("userMentioned",{name:"userMentioned",icon:"fas fa-at",label:a.a.translator.trans("flarum-mentions.forum.settings.notify_user_mentioned_label")})})),a.a.routes["user.mentions"]={path:"/u/:username/mentions",component:_t},Object(s.extend)($t.a.prototype,"navItems",(function(t){var e=this.user;t.add("mentions",Mt.a.component({href:a.a.route("user.mentions",{username:e.slug()}),name:"mentions",icon:"fas fa-at"},a.a.translator.trans("flarum-mentions.forum.user.mentions_link")),80)})),f.getPlainContent.removeSelectors.push("a.PostMention")})),Object.assign(Ht.compat,St)}]);
//# sourceMappingURL=forum.js.map